(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();const at={wind:20,windDir:90,rain:0,fog:0,temperature:20,storm:0,snow:0,hourOverride:-1},ht={fontFamily:"'JetBrains Mono', monospace",fontSize:28,lineHeight:42,persistenceSeconds:8,particlesPerLetter:60,inkHueOverride:0},lt={masterLinear:.8,scaleMode:"auto",initialScale:"pentatonic",layers:{rhythm:{volume:-14,muted:!1,waveform:"membrane",attack:.002,decay:.15,release:.1},drone:{volume:-22,muted:!1,waveform:"sine",attack:4,release:6,filterFreq:400},melody:{volume:-16,muted:!1,waveform:"triangle",attack:.005,decay:.6,release:1.5,mode:"random",reverb:.35},wind:{volume:-35,muted:!1}}},ct={bpm:120},k={weather:at,text:ht,sound:lt,autoTypewriter:ct},Z=k.text.persistenceSeconds*1e3,m={DEFAULTS:k,PIXEL_RATIO:Math.min(window.devicePixelRatio,2),SKY_PALETTES:[{hour:0,top:[.02,.02,.06],bottom:[.04,.03,.1]},{hour:4,top:[.04,.04,.14],bottom:[.08,.06,.18]},{hour:5.5,top:[.12,.08,.22],bottom:[.4,.18,.25]},{hour:6.5,top:[.3,.25,.5],bottom:[.85,.45,.25]},{hour:8,top:[.35,.55,.85],bottom:[.65,.75,.9]},{hour:12,top:[.42,.62,.92],bottom:[.7,.82,.95]},{hour:16,top:[.4,.55,.82],bottom:[.75,.7,.65]},{hour:18,top:[.3,.2,.5],bottom:[.9,.4,.2]},{hour:19.5,top:[.15,.08,.35],bottom:[.5,.15,.3]},{hour:21,top:[.04,.03,.12],bottom:[.08,.05,.16]},{hour:24,top:[.02,.02,.06],bottom:[.04,.03,.1]}],TEXT:{FONT_FAMILY:k.text.fontFamily,FONT_SIZE:k.text.fontSize,LINE_HEIGHT:k.text.lineHeight,INK_COLOR_DAY:[.15,.12,.1],INK_COLOR_NIGHT:[.85,.8,.72],BIRTH_DURATION:400,LIFE_MIN:Z,LIFE_MAX:Z*2,EROSION_DURATION:4e3,PARTICLES_PER_LETTER:k.text.particlesPerLetter,_hueOverride:k.text.inkHueOverride},WIND:{DEFAULT_INTENSITY:k.weather.wind,DEFAULT_DIRECTION:k.weather.windDir,NOISE_SCALE:.003,NOISE_SPEED:4e-4,TURBULENCE_OCTAVES:3},PARTICLES:{MAX_COUNT:1e4,DEFAULT_LIFE:4e3,MIN_SIZE:1,MAX_SIZE:4,GRAVITY:.02},WEATHER:{TRANSITION_SPEED:.005},SOUND:{MASTER_LINEAR:k.sound.masterLinear},AUTO:{DEFAULT_BPM:k.autoTypewriter.bpm},CURSOR:{LIGHT_RADIUS:120,GLOW_COLOR:[1,.85,.55],GLOW_INTENSITY:.6},GRASS:{IDLE_THRESHOLD:3e4,MAX_BLADES:500,BLADE_HEIGHT_MIN:8,BLADE_HEIGHT_MAX:30,COLOR:[.25,.55,.2]},MODES:{WRITER_WPM_THRESHOLD:5,STORM_WPM_THRESHOLD:60,CONTEMPLATOR_IDLE:5e3}};function M(w,t,e){return w+(t-w)*e}function I(w,t,e){return Math.max(t,Math.min(e,w))}function dt(w,t,e){const i=I((e-w)/(t-w),0,1);return i*i*(3-2*i)}function J(w,t,e){return[M(w[0],t[0],e),M(w[1],t[1],e),M(w[2],t[2],e)]}function ut(w){return w*(Math.PI/180)}function p(w,t){return w+Math.random()*(t-w)}function mt(w){return 1-Math.pow(1-w,3)}function ft(w,t,e,i){const r=e-w,s=i-t;return Math.sqrt(r*r+s*s)}const pt=.5*(Math.sqrt(3)-1),B=(3-Math.sqrt(3))/6,yt=1/3,A=1/6;class gt{constructor(t=Math.random()){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);const e=new Uint8Array(256);for(let r=0;r<256;r++)e[r]=r;let i=t*2147483647;i<=0&&(i+=2147483646);for(let r=255;r>0;r--){i=i*16807%2147483647;const s=i%(r+1);[e[r],e[s]]=[e[s],e[r]]}for(let r=0;r<512;r++)this.perm[r]=e[r&255],this.permMod12[r]=this.perm[r]%12}dot2(t,e,i){return t[0]*e+t[1]*i}dot3(t,e,i,r){return t[0]*e+t[1]*i+t[2]*r}noise2D(t,e){const i=(t+e)*pt,r=Math.floor(t+i),s=Math.floor(e+i),n=(r+s)*B,o=r-n,h=s-n,l=t-o,a=e-h;let d,u;l>a?(d=1,u=0):(d=0,u=1);const S=l-d+B,c=a-u+B,f=l-1+2*B,g=a-1+2*B,y=r&255,T=s&255,v=this.permMod12[y+this.perm[T]],E=this.permMod12[y+d+this.perm[T+u]],L=this.permMod12[y+1+this.perm[T+1]];let P=0,x=0,F=0,C=.5-l*l-a*a;C>=0&&(C*=C,P=C*C*this.dot2(this.grad3[v],l,a));let D=.5-S*S-c*c;D>=0&&(D*=D,x=D*D*this.dot2(this.grad3[E],S,c));let _=.5-f*f-g*g;return _>=0&&(_*=_,F=_*_*this.dot2(this.grad3[L],f,g)),70*(P+x+F)}noise3D(t,e,i){const r=(t+e+i)*yt,s=Math.floor(t+r),n=Math.floor(e+r),o=Math.floor(i+r),h=(s+n+o)*A,l=s-h,a=n-h,d=o-h,u=t-l,S=e-a,c=i-d;let f,g,y,T,v,E;u>=S?S>=c?(f=1,g=0,y=0,T=1,v=1,E=0):u>=c?(f=1,g=0,y=0,T=1,v=0,E=1):(f=0,g=0,y=1,T=1,v=0,E=1):S<c?(f=0,g=0,y=1,T=0,v=1,E=1):u<c?(f=0,g=1,y=0,T=0,v=1,E=1):(f=0,g=1,y=0,T=1,v=1,E=0);const L=u-f+A,P=S-g+A,x=c-y+A,F=u-T+2*A,C=S-v+2*A,D=c-E+2*A,_=u-1+3*A,W=S-1+3*A,Y=c-1+3*A,H=s&255,$=n&255,X=o&255,st=this.permMod12[H+this.perm[$+this.perm[X]]],rt=this.permMod12[H+f+this.perm[$+g+this.perm[X+y]]],nt=this.permMod12[H+T+this.perm[$+v+this.perm[X+E]]],ot=this.permMod12[H+1+this.perm[$+1+this.perm[X+1]]];let z=0,V=0,j=0,K=0,R=.6-u*u-S*S-c*c;R>=0&&(R*=R,z=R*R*this.dot3(this.grad3[st],u,S,c));let O=.6-L*L-P*P-x*x;O>=0&&(O*=O,V=O*O*this.dot3(this.grad3[rt],L,P,x));let N=.6-F*F-C*C-D*D;N>=0&&(N*=N,j=N*N*this.dot3(this.grad3[nt],F,C,D));let G=.6-_*_-W*W-Y*Y;return G>=0&&(G*=G,K=G*G*this.dot3(this.grad3[ot],_,W,Y)),32*(z+V+j+K)}fbm2D(t,e,i=3,r=2,s=.5){let n=0,o=1,h=1,l=0;for(let a=0;a<i;a++)n+=this.noise2D(t*h,e*h)*o,l+=o,o*=s,h*=r;return n/l}fbm3D(t,e,i,r=3,s=2,n=.5){let o=0,h=1,l=1,a=0;for(let d=0;d<r;d++)o+=this.noise3D(t*l,e*l,i*l)*h,a+=h,h*=n,l*=s;return o/a}}const U=new gt(42);class wt{constructor(){this.starField=[],this.cloudOffset=0,this.cloudCanvas=null,this.cloudCtx=null,this.cloudNeedsUpdate=!0,this.cloudUpdateTimer=0,this.cloudPuffs=[]}init(t){this.starField=[];for(let e=0;e<200;e++)this.starField.push({x:Math.random(),y:Math.random()*.7,size:.5+Math.random()*1.5,flicker:Math.random()*Math.PI*2,speed:.5+Math.random()*2});this.cloudCanvas=document.createElement("canvas"),this.cloudCtx=this.cloudCanvas.getContext("2d"),this.generateCloudFormations()}generateCloudFormations(){this.cloudPuffs=[];const t=12;for(let e=0;e<t;e++){const i=p(0,1.4)-.2,r=p(.05,.4),s=p(.06,.18),n=Math.floor(p(5,15)),o=Math.floor(p(0,3));for(let h=0;h<n;h++){const l=p(0,Math.PI*2),a=p(0,s*.7);this.cloudPuffs.push({x:i+Math.cos(l)*a,y:r+Math.sin(l)*a*.5,radius:p(s*.3,s*.9),opacity:p(.15,.5),layer:o,noisePhase:p(0,100)})}}this.cloudPuffs.sort((e,i)=>e.layer-i.layer)}resize(t){this.cloudCanvas&&(this.cloudCanvas.width=Math.floor(window.innerWidth*.5),this.cloudCanvas.height=Math.floor(window.innerHeight*.5))}getColorsForHour(t){const e=m.SKY_PALETTES;let i=e[0],r=e[1];for(let h=0;h<e.length-1;h++)if(t>=e[h].hour&&t<e[h+1].hour){i=e[h],r=e[h+1];break}const s=r.hour-i.hour,n=s>0?(t-i.hour)/s:0,o=dt(0,1,n);return{top:J(i.top,r.top,o),bottom:J(i.bottom,r.bottom,o)}}render(t,e,i,r,s){const n=this.getColorsForHour(r),o=s.get("storm")/100,h=s.get("fog")/100,l=s.get("rain")/100,a=o*.5,d=l*.2;let u=I((n.top[0]-a-d)*255,0,255),S=I((n.top[1]-a-d)*255,0,255),c=I((n.top[2]-a*.3)*255,0,255),f=I((n.bottom[0]-a-d)*255,0,255),g=I((n.bottom[1]-a-d)*255,0,255),y=I((n.bottom[2]-a*.3)*255,0,255);const T=t.createLinearGradient(0,0,0,i);T.addColorStop(0,`rgb(${u},${S},${c})`),T.addColorStop(1,`rgb(${f},${g},${y})`),t.fillStyle=T,t.fillRect(0,0,e,i);const v=this.getNightness(r);v>.05&&this.renderStars(t,e,i,v,h);const E=I(l*.7+o*.9+h*.3+.1,0,1);E>.05&&this.renderClouds(t,e,i,r,E,s),this.renderWindParticles(t,e,i,s)}getNightness(t){return t<5?1:t<7?1-(t-5)/2:t<18?0:t<20?(t-18)/2:1}renderStars(t,e,i,r,s){const n=r*(1-s*.8);if(n<.02)return;const o=Date.now()*.001;for(const h of this.starField){const l=.5+.5*Math.sin(o*h.speed+h.flicker),a=n*l*.8;a<.02||(t.fillStyle=`rgba(220, 215, 200, ${a})`,t.beginPath(),t.arc(h.x*e,h.y*i,h.size,0,Math.PI*2),t.fill())}}renderClouds(t,e,i,r,s,n){const o=Date.now()*5e-5,h=n.get("wind")/100;this.cloudOffset+=h*3e-4;const l=this.getNightness(r),a=n.get("storm")/100;let d,u,S;l>.5?(d=M(60,30,a),u=M(60,30,a),S=M(75,40,a)):(d=M(240,120,a),u=M(240,115,a),S=M(250,130,a)),t.save();for(const c of this.cloudPuffs){const f=U.noise2D(c.noisePhase+o*2,0)*.02,g=U.noise2D(0,c.noisePhase+o*1.5)*.01,y=(c.x+this.cloudOffset*(1+c.layer*.3)+f)%1.6-.2,T=c.y+g,v=y*e,E=T*i,L=c.radius*Math.min(e,i);if(v<-L*2||v>e+L*2||E<-L*2||E>i)continue;const P=c.opacity*s*(.4+a*.4),x=t.createRadialGradient(v,E,L*.1,v,E,L);x.addColorStop(0,`rgba(${d},${u},${S},${P})`),x.addColorStop(.4,`rgba(${d},${u},${S},${P*.6})`),x.addColorStop(.7,`rgba(${d},${u},${S},${P*.2})`),x.addColorStop(1,`rgba(${d},${u},${S},0)`),t.fillStyle=x,t.beginPath(),t.arc(v,E,L,0,Math.PI*2),t.fill()}t.restore()}renderWindParticles(t,e,i,r){const s=r.get("wind")/100;if(s<.05)return;if(!this._windMotes){this._windMotes=[];for(let g=0;g<300;g++)this._windMotes.push({x:Math.random()*e,y:Math.random()*i,size:p(.5,2.5),speed:p(.3,1),opacity:p(.05,.2),phase:Math.random()*Math.PI*2,drift:p(-.3,.3)})}const n=r.get("windDir")*Math.PI/180,o=Math.cos(n),h=Math.sin(n),l=Date.now()*.001,a=r.getCurrentHour(),d=this.getNightness(a),u=Math.floor(s*300),S=d>.5?160:220,c=d>.5?155:215,f=d>.5?170:200;for(let g=0;g<u&&g<this._windMotes.length;g++){const y=this._windMotes[g],T=Math.sin(l*.5+y.phase)*y.drift;y.x+=o*s*y.speed*2+T,y.y+=h*s*y.speed*2+Math.sin(l+y.phase)*.2,y.x>e+10&&(y.x=-10),y.x<-10&&(y.x=e+10),y.y>i+10&&(y.y=-10),y.y<-10&&(y.y=i+10);const v=y.opacity*s;v<.01||(t.fillStyle=`rgba(${S},${c},${f},${v})`,t.beginPath(),t.arc(y.x,y.y,y.size,0,Math.PI*2),t.fill())}}}class St{constructor(){this.intensity=m.WIND.DEFAULT_INTENSITY,this.direction=m.WIND.DEFAULT_DIRECTION,this.time=0}init(t){}setIntensity(t){this.intensity=I(t,0,100)}setDirection(t){this.direction=t%360}update(t,e){this.time+=t*m.WIND.NOISE_SPEED;const i=e.weather;this.intensity=i.get("wind"),this.direction=i.get("windDir")}getForceAt(t,e){const i=m.WIND.NOISE_SCALE,r=m.WIND.TURBULENCE_OCTAVES,s=this.intensity/100,n=ut(this.direction),o=Math.cos(n)*s,h=Math.sin(n)*s,l=U.fbm3D(t*i,e*i,this.time,r),a=U.fbm3D(t*i+100,e*i+100,this.time,r),d=s*.6;return{fx:o+l*d,fy:h+a*d}}getSpeedAt(t,e){const i=this.getForceAt(t,e);return Math.sqrt(i.fx*i.fx+i.fy*i.fy)}}class Tt{constructor(){this.pool=[],this.activeCount=0}init(t){this.pool=new Array(m.PARTICLES.MAX_COUNT);for(let e=0;e<this.pool.length;e++)this.pool[e]={active:!1,x:0,y:0,vx:0,vy:0,life:0,maxLife:0,size:1,r:200,g:190,b:170,opacity:1,type:"dust"};this.activeCount=0}resize(t){}emit(t,e,i,r={}){const{color:s=[200,190,170],sizeMin:n=m.PARTICLES.MIN_SIZE,sizeMax:o=m.PARTICLES.MAX_SIZE,life:h=m.PARTICLES.DEFAULT_LIFE,spread:l=30,velocityScale:a=1,type:d="dust"}=r;let u=0;for(let S=0;S<this.pool.length&&u<i;S++){const c=this.pool[S];c.active||(c.active=!0,c.x=t+p(-l*.3,l*.3),c.y=e+p(-l*.3,l*.3),c.vx=p(-l,l)*.02*a,c.vy=p(-l,l)*.02*a,c.life=h+p(-h*.3,h*.3),c.maxLife=c.life,c.size=p(n,o),c.r=s[0],c.g=s[1],c.b=s[2],c.opacity=1,c.type=d,u++,this.activeCount++)}return u}update(t,e){const i=e.wind,r=m.PARTICLES.GRAVITY;this.activeCount=0;for(let s=0;s<this.pool.length;s++){const n=this.pool[s];if(!n.active)continue;if(n.life-=t,n.life<=0){n.active=!1;continue}this.activeCount++;const o=n.life/n.maxLife;n.opacity=Math.min(o*3,1);const h=i.getForceAt(n.x,n.y);n.vx+=h.fx*t*.005,n.vy+=h.fy*t*.005,n.vy+=r*t*.01,n.vx*=.998,n.vy*=.998,n.x+=n.vx*t*.1,n.y+=n.vy*t*.1,n.size*=1-1e-4*t}}render(t,e,i,r){for(let s=0;s<this.pool.length;s++){const n=this.pool[s];if(!n.active)continue;if(n.x<-20||n.x>e+20||n.y<-20||n.y>i+20){n.active=!1,this.activeCount--;continue}const o=I(n.opacity,0,1);o<.01||(t.fillStyle=`rgba(${n.r},${n.g},${n.b},${o})`,t.beginPath(),t.arc(n.x,n.y,n.size,0,Math.PI*2),t.fill())}}}const b={BIRTH:"birth",LIFE:"life",EROSION:"erosion",DEAD:"dead"},vt=["-","\\","|","/","-","\\","|","/"];class Et{constructor(){this.letters=[],this.writeX=100,this.writeY=100,this.cursorBlink=0,this.wordBuffer="",this.lineStartX=100,this.lastStrokeSoundAt=0,this.lastStrokeAngle=null}init(t){}resize(t){}onCanvasClick(t,e,i){this.writeX=t,this.writeY=e,this.lineStartX=t,this.lastStrokeAngle=null,this.wordBuffer.length>0&&this.checkWord(i),this.wordBuffer=""}getStrokeSpacing(){return Math.max(8,Math.round(m.TEXT.FONT_SIZE*.35))}_createLetter(t,e,i,r=1){return{char:t,x:e,y:i,phase:b.BIRTH,birthTimer:0,lifeTimer:0,erosionTimer:0,maxLife:(m.TEXT.LIFE_MIN+p(0,m.TEXT.LIFE_MAX))*r,maxErosion:m.TEXT.EROSION_DURATION,opacity:0,scale:1,vx:0,vy:0,contemplated:!1,contemplateTime:0,shakex:0,shakey:0}}onKey(t,e){const i=t.key;if(i==="Enter"){t.preventDefault(),this.checkWord(e),this.accelerateErosion(e),this.newLine();return}if(i===" "){this.addLetter(" ",e),this.checkWord(e);return}if(i==="Backspace"){this.eraseLastLetter(e);return}i.length===1&&!t.ctrlKey&&!t.metaKey&&(this.addLetter(i,e),this.wordBuffer+=i.toLowerCase())}eraseLastLetter(t){var e,i;for(let r=this.letters.length-1;r>=0;r--){const s=this.letters[r];if(s.phase===b.LIFE||s.phase===b.BIRTH){s.phase=b.EROSION,s.erosionTimer=0,s.maxErosion=m.TEXT.EROSION_DURATION*.3;const n=t.ctx;n.font=`${m.TEXT.FONT_SIZE}px ${m.TEXT.FONT_FAMILY}`,this.writeX-=n.measureText(s.char).width+2,(i=(e=t.sound)==null?void 0:e.onLetterErosion)==null||i.call(e,s);break}}this.wordBuffer.length>0&&(this.wordBuffer=this.wordBuffer.slice(0,-1))}accelerateErosion(t){var s,n;const e=this.writeY,i=m.TEXT.LINE_HEIGHT*.6;let r=0;for(const o of this.letters)Math.abs(o.y-e)<i&&(o.phase===b.LIFE||o.phase===b.BIRTH)&&(o.phase=b.EROSION,o.erosionTimer=-r*80,o.maxErosion=m.TEXT.EROSION_DURATION*(.3+Math.random()*.4),r++,(n=(s=t.sound)==null?void 0:s.onLetterErosion)==null||n.call(s,o))}checkWord(t){if(this.wordBuffer.length>=2){const e=this.wordBuffer.trim();if(e){const i=t.semantic.lookup(e);i&&(t.weather.applySemanticEffects(i.effects,e),i.special&&this.triggerSpecialEffect(i.special,t),this.markWordForContemplation(e))}}this.wordBuffer=""}markWordForContemplation(t){let e=0;for(let i=this.letters.length-1;i>=0&&e<t.length+1;i--){const r=this.letters[i];r.phase!==b.DEAD&&r.char!==" "&&(r.contemplated=!0,r.contemplateTime=2e3,e++)}}triggerSpecialEffect(t,e){switch(t.effect){case"gleaning_mode":e.particles.emit(window.innerWidth*.5,window.innerHeight*.9,200,{spread:window.innerWidth*.4,life:5e3,velocityScale:-2});break;case"palimpsest_reveal":e.memory.reveal(3e3);break;case"suspension":e.modes.triggerSuspension(5e3);break;case"time_lapse":e.weather.triggerTimeLapse(6);break;case"heart_formation":this.emitHeartParticles(e);break;case"erosion_burst":this.erodeAllLetters(e);break;case"rapid_aging":e.memory.accelerateAging(5e3);break;case"full_reveal":e.memory.reveal(8e3),e.modes.triggerSuspension(8e3);break}}emitHeartParticles(t){const e=window.innerWidth*.5,i=window.innerHeight*.4;for(let r=0;r<Math.PI*2;r+=.05){const s=e+960*Math.pow(Math.sin(r),3),n=i-60*(13*Math.cos(r)-5*Math.cos(2*r)-2*Math.cos(3*r)-Math.cos(4*r));t.particles.emit(e+(s-e)*.18,i+(n-i)*.18,1,{color:[220,120,130],life:4e3,sizeMin:2,sizeMax:4})}}erodeAllLetters(t){var i,r;let e=0;for(const s of this.letters)(s.phase===b.LIFE||s.phase===b.BIRTH)&&(s.phase=b.EROSION,s.erosionTimer=-e*30,e++,(r=(i=t.sound)==null?void 0:i.onLetterErosion)==null||r.call(i,s))}addLetter(t,e){const i=window.innerWidth;this.writeX>i-60&&this.newLine();const r=this._createLetter(t,this.writeX,this.writeY,1);this.letters.push(r);const s=e.ctx;s.font=`${m.TEXT.FONT_SIZE}px ${m.TEXT.FONT_FAMILY}`,this.writeX+=s.measureText(t).width+2,this.cursorBlink=0}addStrokePoint(t,e,i,r=.4){var c,f,g,y;const s=(r==null?void 0:r.dx)??0,n=(r==null?void 0:r.dy)??0,o=Math.abs((r==null?void 0:r.speed)??0);let h=Math.atan2(n,s)*(180/Math.PI);Number.isFinite(h)||(h=0);const l=(Math.round(h/45)%8+8)%8;let a=vt[l],d=0;this.lastStrokeAngle!==null&&(d=Math.abs(h-this.lastStrokeAngle),d>180&&(d=360-d)),this.lastStrokeAngle=h,d>75?a="o":d>35?a="+":o<10?a=".":o<18?a=":":o>70?a="#":o>45&&a==="-"&&(a="=");const u=this._createLetter(a,t,e,.55);u.scale=.8+Math.random()*.25,this.letters.push(u),this.writeX=t,this.writeY=e,this.lineStartX=t,this.cursorBlink=0;const S=Date.now();i!=null&&i.sound&&(i!=null&&i.weather)&&S-this.lastStrokeSoundAt>55&&((f=(c=i.sound).playGestureTone)!=null&&f.call(c,l,I(o/75,0,1))||(y=(g=i.sound).onKey)==null||y.call(g,{key:"q"},i.weather),this.lastStrokeSoundAt=S)}newLine(){this.writeX=this.lineStartX,this.writeY+=m.TEXT.LINE_HEIGHT;const t=window.innerHeight-60;if(this.writeY>t){const e=m.TEXT.LINE_HEIGHT;this.writeY-=e;for(const i of this.letters)i.y-=e}}update(t,e){var o,h;const i=e.cursor,r=e.wind,s=e.weather,n=s.get("wind")/100;for(let l=this.letters.length-1;l>=0;l--){const a=this.letters[l];if(a.phase===b.DEAD){e.memory.recordLetter(a),this.letters.splice(l,1);continue}const u=ft(a.x,a.y,i.x,i.y)<m.CURSOR.LIGHT_RADIUS;switch(a.phase){case b.BIRTH:a.birthTimer+=t,a.opacity=mt(I(a.birthTimer/m.TEXT.BIRTH_DURATION,0,1)),a.birthTimer>=m.TEXT.BIRTH_DURATION&&(a.phase=b.LIFE,a.opacity=1);break;case b.LIFE:if(a.contemplated&&a.contemplateTime>0){a.contemplateTime-=t,a.scale=1+Math.sin(Date.now()*.005)*.03;break}u||(a.lifeTimer+=t),a.scale=1+Math.sin(Date.now()*.002+a.x)*.01;const c=a.lifeTimer/a.maxLife;if(c>.7){const T=(c-.7)/.3;a.shakex=(Math.random()-.5)*T*3*(1+n*2),a.shakey=(Math.random()-.5)*T*2}a.lifeTimer>=a.maxLife*(1-n*.5)&&(a.phase=b.EROSION,a.erosionTimer=0,(h=(o=e.sound)==null?void 0:o.onLetterErosion)==null||h.call(o,a));break;case b.EROSION:if(a.erosionTimer+=t,a.erosionTimer<0)break;const f=a.maxErosion||m.TEXT.EROSION_DURATION,g=a.erosionTimer/f;a.opacity=1-g,a.shakex=(Math.random()-.5)*4*(1+n*3),a.shakey=(Math.random()-.5)*3;const y=r.getForceAt(a.x,a.y);a.vx+=y.fx*t*.003,a.vy+=y.fy*t*.003,a.x+=a.vx,a.y+=a.vy,g>.2&&Math.random()<.15&&e.particles.emit(a.x,a.y,2,{color:this.getInkColor(s.getCurrentHour()),spread:10+n*30,life:3e3+n*4e3,sizeMin:1,sizeMax:3}),g>=1&&(e.particles.emit(a.x,a.y,m.TEXT.PARTICLES_PER_LETTER,{color:this.getInkColor(s.getCurrentHour()),spread:20+n*40,life:4e3}),a.phase=b.DEAD);break}const S=s.get("rain")/100;S>.3&&a.phase===b.LIFE&&(a.y+=S*.02*t*.01,a.opacity*=1-S*1e-4*t,a.opacity<.05&&(a.phase=b.DEAD))}this.cursorBlink+=t}getInkColor(t){const e=t<6||t>20?1:t<8?(8-t)/2:t>18?(t-18)/2:0,i=m.TEXT.INK_COLOR_DAY.map(s=>s*255),r=m.TEXT.INK_COLOR_NIGHT.map(s=>s*255);return[Math.round(i[0]+(r[0]-i[0])*e),Math.round(i[1]+(r[1]-i[1])*e),Math.round(i[2]+(r[2]-i[2])*e)]}render(t,e,i,r){const s=r.weather.getCurrentHour(),n=m.TEXT._hueOverride||0,o=n>0?this.hueToRGB(n,s):this.getInkColor(s);t.font=`${m.TEXT.FONT_SIZE}px ${m.TEXT.FONT_FAMILY}`,t.textBaseline="top";for(const h of this.letters)h.phase===b.DEAD||h.opacity<.01||(t.save(),t.translate(h.x+h.shakex,h.y+h.shakey),t.scale(h.scale,h.scale),h.contemplated&&h.contemplateTime>0&&(t.shadowColor="rgba(255,220,150,0.5)",t.shadowBlur=8),t.fillStyle=`rgba(${o[0]},${o[1]},${o[2]},${h.opacity})`,t.fillText(h.char,0,0),t.shadowBlur=0,t.restore());Math.sin(this.cursorBlink*.003)>0&&(t.fillStyle=`rgba(${o[0]},${o[1]},${o[2]},0.5)`,t.fillRect(this.writeX,this.writeY,2,m.TEXT.FONT_SIZE))}hueToRGB(t,e){const r=e<6||e>20?.78:.25,s=.6,n=t/360,o=r<.5?r*(1+s):r+s-r*s,h=2*r-o,l=(a,d,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<1/6?a+(d-a)*6*u:u<1/2?d:u<2/3?a+(d-a)*(2/3-u)*6:a);return[Math.round(l(h,o,n+1/3)*255),Math.round(l(h,o,n)*255),Math.round(l(h,o,n-1/3)*255)]}}class It{constructor(){const t=m.DEFAULTS.weather;this.current={wind:t.wind,windDir:t.windDir,rain:t.rain,fog:t.fog,temperature:t.temperature,storm:t.storm,snow:t.snow,hourOverride:t.hourOverride},this.target={...this.current},this.semanticPush={temperature:0,heat_haze:0,snow:0,wind_intensity:0,storm:0,rain:0,fog:0,letter_life:0,hour_shift:0,luminosity:0},this.timeLapse=null}init(t){}get(t){return this.current[t]??0}set(t,e){this.target[t]=e}getCurrentHour(){const t=new Date;let e=t.getHours()+t.getMinutes()/60;return this.current.hourOverride>=0&&this.current.hourOverride<=24&&(e=this.current.hourOverride),e+=this.semanticPush.hour_shift*2,this.timeLapse&&(e=this.timeLapse.currentHour),(e%24+24)%24}applySemanticEffects(t,e){for(const[i,r]of Object.entries(t))i in this.semanticPush&&(this.semanticPush[i]+=r*.3);this.target.rain=I(this.target.rain+this.semanticPush.rain*20,0,100),this.target.wind=I(this.target.wind+this.semanticPush.wind_intensity*15,0,100),this.target.storm=I(this.target.storm+this.semanticPush.storm*20,0,100),this.target.fog=I(this.target.fog+this.semanticPush.fog*25,0,100),this.target.temperature=I(this.target.temperature+this.semanticPush.temperature*5,-10,45)}triggerTimeLapse(t){const e=this.getCurrentHour();this.timeLapse={startHour:e,targetHour:(e+t)%24,currentHour:e,progress:0,duration:5e3}}update(t,e){var r,s;const i=m.WEATHER.TRANSITION_SPEED;for(const n in this.current)n!=="hourOverride"&&(this.current[n]=M(this.current[n],this.target[n],i*t*.06));this.current.hourOverride=this.target.hourOverride;for(const n in this.semanticPush)this.semanticPush[n]*=.999;if(this.timeLapse)if(this.timeLapse.progress+=t/this.timeLapse.duration,this.timeLapse.progress>=1)this.timeLapse=null;else{const n=this.timeLapse.progress;this.timeLapse.currentHour=M(this.timeLapse.startHour,this.timeLapse.targetHour,n)}this.current.storm>40&&Math.random()<this.current.storm*5e-5*t&&((s=(r=e.sound)==null?void 0:r.playThunder)==null||s.call(r,this.current.storm/100))}}const bt="modulepreload",Mt=function(w,t){return new URL(w,t).href},Q={},Lt=function(t,e,i){let r=Promise.resolve();if(e&&e.length>0){let n=function(a){return Promise.all(a.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const o=document.getElementsByTagName("link"),h=document.querySelector("meta[property=csp-nonce]"),l=(h==null?void 0:h.nonce)||(h==null?void 0:h.getAttribute("nonce"));r=n(e.map(a=>{if(a=Mt(a,i),a in Q)return;Q[a]=!0;const d=a.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(!!i)for(let f=o.length-1;f>=0;f--){const g=o[f];if(g.href===a&&(!d||g.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${u}`))return;const c=document.createElement("link");if(c.rel=d?"stylesheet":bt,d||(c.as="script"),c.crossOrigin="",c.href=a,l&&c.setAttribute("nonce",l),document.head.appendChild(c),d)return new Promise((f,g)=>{c.addEventListener("load",f),c.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${a}`)))})}))}function s(n){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=n,window.dispatchEvent(o),!o.defaultPrevented)throw n}return r.then(n=>{for(const o of n||[])o.status==="rejected"&&s(o.reason);return t().catch(s)})},tt={aeolian:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],pentatonic:[0,2,4,7,9],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]},et={aeolian:"Menor Natural (E√≥lica)",dorian:"D√≥rica",pentatonic:"Pentat√≥nica",phrygian:"Frigia",lydian:"Lidia",chromatic:"Crom√°tica"},xt={z:48,s:49,x:50,d:51,c:52,v:53,g:54,b:55,h:56,n:57,j:58,m:59,q:60,2:61,w:62,3:63,e:64,r:65,5:66,t:67,6:68,y:69,7:70,u:71,i:72,9:73,o:74,0:75,p:76},kt={default:"pentatonic",storm:"phrygian",cold:"aeolian",hot:"lydian"},q={0:"C2",4:"D2",6:"E2",8:"G2",12:"A2",16:"F2",18:"E2",20:"D2",22:"C2"};class Pt{constructor(){var r,s;this.initialized=!1,this.enabled=!1,this.Tone=null,this.initPromise=null;const t=((r=m.DEFAULTS)==null?void 0:r.sound)||{},e=t.layers||{};this.params={rhythm:{volume:-14,muted:!1,waveform:"membrane",attack:.002,decay:.15,release:.1,...e.rhythm||{}},drone:{volume:-22,muted:!1,waveform:"sine",attack:4,release:6,filterFreq:400,...e.drone||{}},melody:{volume:-16,muted:!1,waveform:"triangle",attack:.005,decay:.6,release:1.5,mode:"random",reverb:.35,...e.melody||{}},wind:{volume:-35,muted:!1,...e.wind||{}}},this.masterLevel=(s=m.SOUND)==null?void 0:s.MASTER_LINEAR,this.scaleMode=t.scaleMode||"auto",this.scalesLoaded=!1,this.scalesData=Object.fromEntries(Object.entries(tt).map(([n,o])=>[n,{label:et[n]||n,notes:o}]));const i=t.initialScale||"pentatonic";this.currentScale=this.scalesData[i]?i:"pentatonic",this.pianoMap={...xt},this.weatherScaleMap={...kt},this.droneFreq=65.41,this.lastNoteTime=0,this.noteIndex=0,this.rhythmSynth=null,this.rhythmNoiseSynth=null,this.droneSynth=null,this.droneFilter=null,this.melodySynth=null,this.windNoise=null,this.windGain=null,this.melodyDryGain=null,this.melodyFxSendGain=null,this.masterGain=null,this.reverb=null,this.delay=null,this.thunderSynth=null,this.rainSynth=null}async init(){if(!this.Tone){if(this.initPromise){await this.initPromise;return}this.initPromise=(async()=>{try{this.Tone=await Lt(()=>import("./index-Cvny4KXv.js"),[],import.meta.url),this._tuneAudioContextForRealtime(),this.loadScales()}catch{console.warn("‚ö†Ô∏è Tone.js not available, sound disabled"),this.Tone=null,this.scalesLoaded=!0}finally{this.initPromise=null}})(),await this.initPromise}}async loadScales(){var t,e;if(!this.scalesLoaded)try{const i=await fetch("/data/scales.json");if(!i.ok)throw new Error(`HTTP ${i.status}`);const r=await i.json();r.scales&&(this.scalesData=r.scales),(e=(t=r.pianoMappings)==null?void 0:t.default)!=null&&e.keys&&(this.pianoMap=r.pianoMappings.default.keys),r.weatherScaleMap&&(this.weatherScaleMap=r.weatherScaleMap);const s=this.scaleMode==="auto"?this.currentScale:this.scaleMode;s&&this.scalesData[s]&&(this.currentScale=s)}catch{}finally{this.scalesLoaded=!0}}buildAudioGraph(){if(!this.Tone||this.initialized)return;const t=this.Tone;this.reverb=new t.Reverb({decay:6,wet:this.params.melody.reverb}).toDestination(),this.delay=new t.FeedbackDelay({delayTime:"8n",feedback:.2,wet:.15}).connect(this.reverb),this.masterGain=new t.Gain(0).toDestination(),this.masterGain.connect(this.delay),this.melodyDryGain=new t.Gain(0).toDestination(),this.melodyFxSendGain=new t.Gain(0).connect(this.masterGain),this.rhythmSynth=new t.MembraneSynth({pitchDecay:.08,octaves:3,envelope:{attack:this.params.rhythm.attack,decay:this.params.rhythm.decay,sustain:0,release:this.params.rhythm.release},volume:this.params.rhythm.volume}).connect(this.masterGain),this.rhythmNoiseSynth=new t.NoiseSynth({noise:{type:"white"},envelope:{attack:.001,decay:.04,sustain:0,release:.02},volume:this.params.rhythm.volume-8}).connect(this.masterGain),this.droneFilter=new t.Filter({frequency:this.params.drone.filterFreq,type:"lowpass",rolloff:-24}).connect(this.masterGain),this.droneSynth=new t.PolySynth(t.FMSynth,{maxPolyphony:4,voice0:{harmonicity:1.5,modulationIndex:.8,oscillator:{type:this.params.drone.waveform},envelope:{attack:this.params.drone.attack,decay:1,sustain:.8,release:this.params.drone.release},modulation:{type:"triangle"},modulationEnvelope:{attack:3,decay:.5,sustain:.7,release:5},volume:this.params.drone.volume}}).connect(this.droneFilter),this.windNoise=new t.Noise("brown").start(),this.windFilter=new t.AutoFilter({frequency:.15,baseFrequency:60,octaves:3}).connect(this.masterGain).start(),this.windGain=new t.Gain(t.dbToGain(this.params.wind.volume)).connect(this.windFilter),this.windNoise.connect(this.windGain),this.melodySynth=new t.PolySynth(t.Synth,{maxPolyphony:8,voice0:{oscillator:{type:this.params.melody.waveform+"8"},envelope:{attack:this.params.melody.attack,decay:this.params.melody.decay,sustain:.15,release:this.params.melody.release},volume:this.params.melody.volume}}),this.melodySynth.connect(this.melodyDryGain),this.melodySynth.connect(this.melodyFxSendGain),this.thunderSynth=new t.NoiseSynth({noise:{type:"brown"},envelope:{attack:.02,decay:2,sustain:0,release:1},volume:-8}).connect(this.reverb),this.rainSynth=new t.MetalSynth({frequency:1200,envelope:{attack:.001,decay:.015,release:.01},harmonicity:15,modulationIndex:30,volume:-28}).connect(this.masterGain),this.initialized=!0,this.applyAllParams()}getAvailableScales(){return Object.entries(this.scalesData).map(([t,e])=>({key:t,label:(e==null?void 0:e.label)||et[t]||t}))}setScale(t){this.scaleMode=t,t!=="auto"&&this.scalesData[t]&&(this.currentScale=t)}_tuneAudioContextForRealtime(){var e,i;if(!this.Tone)return;const t=[(i=(e=this.Tone).getContext)==null?void 0:i.call(e),this.Tone.context].filter(Boolean);for(const r of t){try{r.lookAhead=0}catch{}try{r.updateInterval=.01}catch{}try{r.latencyHint="interactive"}catch{}}}_getMelodyFxSend(){return this.params.melody.muted?0:I(this.params.melody.reverb*.2,0,.25)}_now(){var t;return(t=this.Tone)!=null&&t.immediate?this.Tone.immediate():void 0}_getScale(t){const e=this.scalesData[t];return Array.isArray(e)?e:(e==null?void 0:e.notes)||tt.pentatonic}primeFromGesture(){var t,e;if(!this.Tone)return!1;try{const i=(e=(t=this.Tone).start)==null?void 0:e.call(t);return i!=null&&i.catch&&i.catch(()=>{}),this._tuneAudioContextForRealtime(),this.initialized||this.buildAudioGraph(),this.enabled=!0,this.masterGain&&(this.masterGain.gain.value=this.masterLevel),this.melodyDryGain&&(this.melodyDryGain.gain.value=this.params.melody.muted?0:1),this.melodyFxSendGain&&(this.melodyFxSendGain.gain.value=this._getMelodyFxSend()),this.applyAllParams(),this.params.drone.muted||this.startDrone(),!0}catch{return!1}}async enable(){if(await this.init(),!!this.Tone){if(await this.Tone.start(),this._tuneAudioContextForRealtime(),!this.initialized)try{this.buildAudioGraph()}catch(t){console.error("‚ö†Ô∏è Sound graph init failed",t);return}this.enabled=!0,this.masterGain&&(this.masterGain.gain.value=this.masterLevel),this.melodyDryGain&&(this.melodyDryGain.gain.value=this.params.melody.muted?0:1),this.melodyFxSendGain&&(this.melodyFxSendGain.gain.value=this._getMelodyFxSend()),this.params.drone.muted||this.startDrone(),this.applyAllParams()}}startDrone(){if(!(!this.droneSynth||!this.Tone||this.params.drone.muted))try{const t=this.Tone.Frequency(this.droneFreq).toNote(),e=this.Tone.Frequency(this.droneFreq*1.5).toNote();this.droneSynth.triggerAttack([t,e],this._now())}catch{}}setParam(t,e,i){if(!this.params[t])return;const r=this.params[t][e];if(this.params[t][e]=i,this.applyParams(t),t==="drone"&&e==="muted"&&r!==i&&this.droneSynth)if(i)try{this.droneSynth.releaseAll()}catch{}else this.enabled&&this.startDrone()}applyAllParams(){this.applyParams("rhythm"),this.applyParams("drone"),this.applyParams("melody"),this.applyParams("wind")}applyParams(t){if(!(!this.initialized||!this.Tone))switch(t){case"rhythm":if(this.rhythmSynth){this.rhythmSynth.volume.value=this.params.rhythm.muted?-1/0:this.params.rhythm.volume;try{this.rhythmSynth.set({envelope:{attack:this.params.rhythm.attack,decay:this.params.rhythm.decay,release:this.params.rhythm.release}})}catch{}}this.rhythmNoiseSynth&&(this.rhythmNoiseSynth.volume.value=this.params.rhythm.muted?-1/0:this.params.rhythm.volume-8);break;case"drone":if(this.droneSynth){this.droneSynth.volume.value=this.params.drone.muted?-1/0:this.params.drone.volume;try{this.droneSynth.set({voice0:{oscillator:{type:this.params.drone.waveform},envelope:{attack:this.params.drone.attack,release:this.params.drone.release}}})}catch{}}this.droneFilter&&(this.droneFilter.frequency.value=this.params.drone.filterFreq);break;case"melody":if(this.melodySynth){this.melodySynth.volume.value=this.params.melody.muted?-1/0:this.params.melody.volume;try{this.melodySynth.set({voice0:{oscillator:{type:this.params.melody.waveform+"8"},envelope:{attack:this.params.melody.attack,decay:this.params.melody.decay,release:this.params.melody.release}}})}catch{}}this.reverb&&(this.reverb.wet.value=this.params.melody.reverb),this.melodyDryGain&&(this.melodyDryGain.gain.value=this.params.melody.muted?0:1),this.melodyFxSendGain&&(this.melodyFxSendGain.gain.value=this._getMelodyFxSend());break;case"wind":if(this.windGain){const e=this.params.wind.muted?-80:this.params.wind.volume;this.windGain.gain.value=this.Tone.dbToGain(e)}break}}disable(){if(this.enabled=!1,this.masterGain&&(this.masterGain.gain.value=0),this.melodyDryGain&&(this.melodyDryGain.gain.value=0),this.melodyFxSendGain&&(this.melodyFxSendGain.gain.value=0),this.droneSynth)try{this.droneSynth.releaseAll()}catch{}if(this.melodySynth)try{this.melodySynth.releaseAll()}catch{}}async toggle(){return this.enabled?(this.disable(),!1):(await this.enable(),this.enabled)}playGestureTone(t=0,e=.5){if(!this.enabled||!this.melodySynth||!this.Tone||this.params.melody.muted)return!1;const i=[0,2,4,5,7,9,11,12],r=(Math.round(t)%i.length+i.length)%i.length,s=60+i[r],n=440*Math.pow(2,(s-69)/12),o=.07+I(e,0,1)*.09;try{return this.melodySynth.triggerAttackRelease(n,o,this._now()),!0}catch{return!1}}onKey(t,e){if(!this.enabled||!this.melodySynth||!this.Tone)return;const i=t.key;if(i.length!==1||this.params.melody.muted)return;let r;if(this.params.melody.mode==="piano"){if(r=this.pianoMap[i.toLowerCase()],r===void 0)return}else{const n=this._getScale(this.currentScale),o=i.toLowerCase().charCodeAt(0),h=o%n.length,l=Math.floor(o%26/n.length);r=60+n[h]+l*12}const s=440*Math.pow(2,(r-69)/12);try{this.melodySynth.triggerAttackRelease(s,.12,this._now())}catch{}if(!this.params.rhythm.muted&&this.rhythmNoiseSynth){const n=Date.now();if(n-this.lastNoteTime>50){try{this.rhythmNoiseSynth.triggerAttackRelease("32n",this._now())}catch{}this.lastNoteTime=n}}this.noteIndex++}onLetterErosion(t){if(!this.enabled||!this.rhythmSynth||this.params.rhythm.muted||!this.Tone)return;const e=this._getScale(this.currentScale),r=(t.char||"a").toLowerCase().charCodeAt(0)%e.length,s=36+e[r],n=440*Math.pow(2,(s-69)/12);try{this.rhythmSynth.triggerAttackRelease(n,.08,this._now())}catch{}}playThunder(t){if(!(!this.enabled||!this.thunderSynth))try{this.thunderSynth.volume.value=-12+t*8,this.thunderSynth.triggerAttackRelease("2n",this._now())}catch{}}updateDrone(t,e){if(!this.droneSynth||!this.Tone||this.params.drone.muted)return;const i=Object.keys(q).map(Number).sort((a,d)=>a-d);let r=q[0];for(const a of i)t>=a&&(r=q[a]);const s=this.Tone.Frequency(r).toFrequency();if(Math.abs(this.droneFreq-s)>1){this.droneFreq=s;try{this.droneSynth.releaseAll(),setTimeout(()=>this.startDrone(),40)}catch{}}const n=e.get("temperature"),o=this.params.drone.filterFreq,h=M(Math.max(o*.3,100),o,I((n+10)/55,0,1));this.droneFilter&&(this.droneFilter.frequency.value=h);const l=e.get("storm")/100;this.droneFilter&&(this.droneFilter.Q.value=l*8)}update(t,e){if(!this.enabled||!this.initialized||!this.Tone)return;const i=e.weather,r=i.get("wind")/100,s=i.get("rain")/100,n=i.getCurrentHour();if(this.updateDrone(n,i),this.windGain&&!this.params.wind.muted){const h=this.params.wind.volume+r*15;this.windGain.gain.value=this.Tone.dbToGain(h)}if(s>.1&&this.rainSynth&&!this.params.rhythm.muted&&Math.random()<s*.04)try{this.rainSynth.triggerAttackRelease("64n",this._now())}catch{}if(this.scaleMode==="auto"){const o=i.get("storm")/100,h=i.get("temperature"),l=this.weatherScaleMap;o>.5?this.currentScale=l.storm||"phrygian":h<5?this.currentScale=l.cold||"aeolian":h>30?this.currentScale=l.hot||"lydian":this.currentScale=l.default||"pentatonic"}}}class At{constructor(){this.dictionary={},this.specialWords={},this.poles={},this.loaded=!1}async load(){try{const[t,e]=await Promise.all([fetch("./data/semantic_dict.json"),fetch("./data/special_words.json")]);if(t.ok){const i=await t.json();this.dictionary=i.words||{},this.poles=i.poles||{},console.log(`üìñ Semantic dict: ${Object.keys(this.dictionary).length} words`)}e.ok&&(this.specialWords=await e.json(),console.log(`‚≠ê Special words: ${Object.keys(this.specialWords).length}`)),this.loaded=!0}catch(t){console.warn("‚ö†Ô∏è Could not load semantic dictionary:",t.message),console.log("   The experience will work without word recognition.")}}lookup(t){if(!this.loaded)return null;const e=t.toLowerCase().trim();if(e.length<2)return null;const i={},r=this.dictionary[e];r&&(i.effects=r.effects,i.poles=r.poles);const s=this.specialWords[e];return s&&(i.special=s,i.effects||(i.effects={})),i.effects||i.special?i:null}}class Ct{constructor(){this.x=-100,this.y=-100,this.targetX=-100,this.targetY=-100,this.visible=!1,this.trail=[],this.maxTrail=80,this.lastTrailTime=0,this.lastX=0,this.lastY=0,this.speed=0}init(t){}update(t,e){this.targetX=t,this.targetY=e,this.visible=!0;const i=t-this.lastX,r=e-this.lastY;this.speed=Math.sqrt(i*i+r*r),this.lastX=t,this.lastY=e,this.x+=(this.targetX-this.x)*.2,this.y+=(this.targetY-this.y)*.2;const s=Date.now();if(this.speed>1.5&&s-this.lastTrailTime>20){this.lastTrailTime=s;const n=Math.min(3,Math.floor(this.speed/8)+1);for(let o=0;o<n;o++)this.trail.push({x:this.x+p(-3,3),y:this.y+p(-3,3),vx:p(-.5,.5)-i*.05,vy:p(-.5,.5)-r*.05-p(.1,.4),life:p(800,2e3),maxLife:p(800,2e3),size:p(1.5,4),pulse:p(0,Math.PI*2),pulseSpeed:p(3,8)});for(;this.trail.length>this.maxTrail;)this.trail.shift()}}render(t,e,i,r){if(!this.visible)return;const s=r<6||r>20?1:r<8?(8-r)/2:r>18?(r-18)/2:0,n=m.CURSOR.LIGHT_RADIUS,o=m.CURSOR.GLOW_COLOR,h=m.CURSOR.GLOW_INTENSITY*(.5+s*.5),l=Date.now()*.001;for(let c=this.trail.length-1;c>=0;c--){const f=this.trail[c];if(f.life-=16,f.x+=f.vx,f.y+=f.vy,f.vy-=.003,f.life<=0){this.trail.splice(c,1);continue}const g=f.life/f.maxLife,y=.5+.5*Math.sin(l*f.pulseSpeed+f.pulse),T=g*y*h*.7,v=f.size*(.5+g*.5);if(T<.01)continue;const E=t.createRadialGradient(f.x,f.y,0,f.x,f.y,v*3);E.addColorStop(0,`rgba(255, 230, 150, ${T*.8})`),E.addColorStop(.4,`rgba(255, 200, 100, ${T*.3})`),E.addColorStop(1,"rgba(255, 180, 80, 0)"),t.fillStyle=E,t.beginPath(),t.arc(f.x,f.y,v*3,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 245, 220, ${T*.9})`,t.beginPath(),t.arc(f.x,f.y,v*.5,0,Math.PI*2),t.fill()}const a=.9+.1*Math.sin(l*6)*Math.sin(l*9.7),d=h*a,u=t.createRadialGradient(this.x,this.y,0,this.x,this.y,n);u.addColorStop(0,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, ${d*.25})`),u.addColorStop(.3,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, ${d*.1})`),u.addColorStop(.6,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, ${d*.03})`),u.addColorStop(1,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, 0)`),t.fillStyle=u,t.beginPath(),t.arc(this.x,this.y,n,0,Math.PI*2),t.fill();const S=3+Math.sin(l*7)*.5;t.fillStyle=`rgba(255, 235, 190, ${.7+s*.3})`,t.beginPath(),t.arc(this.x,this.y,S,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 220, 150, ${d*.08})`,t.beginPath(),t.arc(this.x,this.y,n*1.5,0,Math.PI*2),t.fill()}}class Dt{constructor(){this.performanceMode=!1,this.app=null,this.pendingScaleSelection="auto"}init(t,e,i,r){this.weather=e,this.sound=i,this.app=r,document.querySelectorAll(".panel-close").forEach(s=>{s.addEventListener("click",()=>{var o;const n=s.dataset.close;(o=document.getElementById(n))==null||o.classList.add("hidden")})}),this.wireButton("btn-controls",()=>this.togglePanel("controls")),this.wireButton("btn-shortcuts",()=>this.togglePanel("panel-shortcuts")),this.wireButton("btn-about",()=>this.togglePanel("panel-about")),this.wireButton("btn-fullscreen",()=>this.toggleFullscreen()),this.wireButton("btn-sound",async()=>{const s=await i.toggle();document.getElementById("btn-sound").textContent=s?"üîä":"üîá"}),this.wireButton("btn-capture",()=>this.captureScreenshot(t.canvas)),document.querySelectorAll(".tab").forEach(s=>{s.addEventListener("click",()=>{var o;const n=s.closest(".panel");n.querySelectorAll(".tab").forEach(h=>h.classList.remove("active")),n.querySelectorAll(".tab-content").forEach(h=>h.classList.remove("active")),s.classList.add("active"),(o=document.getElementById(s.dataset.tab))==null||o.classList.add("active")})}),this.syncControlsFromRuntime(),this.wireSlider("ctrl-wind",s=>e.set("wind",s)),this.wireSlider("ctrl-wind-dir",s=>e.set("windDir",s),s=>s+"¬∞"),this.wireSlider("ctrl-rain",s=>e.set("rain",s)),this.wireSlider("ctrl-fog",s=>e.set("fog",s)),this.wireSlider("ctrl-temp",s=>e.set("temperature",s),s=>s+"¬∞C"),this.wireSlider("ctrl-storm",s=>e.set("storm",s)),this.wireSlider("ctrl-hour",s=>{e.set("hourOverride",s<0?-1:s)},s=>s<0?"Auto":`${Math.floor(s)}:${String(Math.floor(s%1*60)).padStart(2,"0")}`),this.wireSlider("ctrl-persist",s=>{m.TEXT.LIFE_MIN=s*1e3,m.TEXT.LIFE_MAX=s*2e3},s=>s+"s"),this.wireSlider("ctrl-explosion",s=>{m.TEXT.PARTICLES_PER_LETTER=s},s=>s),this.wireSlider("ctrl-ink-hue",s=>{m.TEXT._hueOverride=s},s=>s===0?"Auto":s+"¬∞"),this.wireSelect("ctrl-font",s=>{m.TEXT.FONT_FAMILY=s}),this.wireSlider("ctrl-font-size",s=>{m.TEXT.FONT_SIZE=s,m.TEXT.LINE_HEIGHT=Math.round(s*1.5)},s=>s+"px"),this.wireToggle("ctrl-rhythm-mute",s=>i.setParam("rhythm","muted",!s)),this.wireSlider("ctrl-rhythm-vol",s=>i.setParam("rhythm","volume",s),s=>s+" dB"),this.wireSlider("ctrl-rhythm-attack",s=>i.setParam("rhythm","attack",s),s=>s.toFixed(3)),this.wireSlider("ctrl-rhythm-decay",s=>i.setParam("rhythm","decay",s),s=>s.toFixed(2)),this.wireSlider("ctrl-rhythm-release",s=>i.setParam("rhythm","release",s),s=>s.toFixed(2)),this.wireToggle("ctrl-wind-mute",s=>i.setParam("wind","muted",!s)),this.wireSlider("ctrl-wind-vol",s=>i.setParam("wind","volume",s),s=>s+" dB"),this.wireToggle("ctrl-drone-mute",s=>i.setParam("drone","muted",!s)),this.wireSlider("ctrl-drone-vol",s=>i.setParam("drone","volume",s),s=>s+" dB"),this.wireSlider("ctrl-drone-filter",s=>i.setParam("drone","filterFreq",s),s=>s+" Hz"),this.wireSlider("ctrl-drone-attack",s=>i.setParam("drone","attack",s),s=>s.toFixed(1)+"s"),this.wireSlider("ctrl-drone-release",s=>i.setParam("drone","release",s),s=>s.toFixed(1)+"s"),this.wireSelect("ctrl-drone-wave",s=>i.setParam("drone","waveform",s)),this.wireToggle("ctrl-melody-mute",s=>i.setParam("melody","muted",!s)),this.wireSlider("ctrl-melody-vol",s=>i.setParam("melody","volume",s),s=>s+" dB"),this.wireSelect("ctrl-melody-mode",s=>i.setParam("melody","mode",s)),this.wireSelect("ctrl-melody-wave",s=>i.setParam("melody","waveform",s)),this.wireSlider("ctrl-melody-attack",s=>i.setParam("melody","attack",s),s=>s.toFixed(3)),this.wireSlider("ctrl-melody-decay",s=>i.setParam("melody","decay",s),s=>s.toFixed(2)),this.wireSlider("ctrl-melody-release",s=>i.setParam("melody","release",s),s=>s.toFixed(1)),this.wireSlider("ctrl-melody-reverb",s=>i.setParam("melody","reverb",s),s=>s.toFixed(2)),this.wireSelect("ctrl-melody-scale",s=>i.setScale(s)),this.populateScaleSelector(i),this.wireFileImport(),this.wireSlider("ctrl-auto-bpm",s=>{this.app&&this.app.setAutoBPM(s)},s=>s+" BPM"),this.wireButton("btn-auto-play",()=>{if(!this.app)return;const s=this.app.toggleAutoPlay(),n=document.getElementById("btn-auto-play");n&&(n.textContent=s?"‚è∏ Pausar":"‚ñ∂ Reproducir")}),this.wireButton("btn-auto-stop",()=>{if(!this.app)return;this.app.stopAutoPlay();const s=document.getElementById("btn-auto-play");s&&(s.textContent="‚ñ∂ Reproducir");const n=document.getElementById("auto-status");n&&(n.textContent="Sin archivo")}),this.startClock()}wireButton(t,e){const i=document.getElementById(t);i&&i.addEventListener("click",e)}setControlValue(t,e){const i=document.getElementById(t);if(!i||e===void 0||e===null)return;const r=String(e);i.tagName==="SELECT"&&!Array.from(i.options).some(n=>n.value===r)||(i.value=r)}setControlChecked(t,e){const i=document.getElementById(t);i&&(i.checked=!!e)}syncControlsFromRuntime(){var i;const t=this.weather.current,e=this.sound.params;this.setControlValue("ctrl-wind",t.wind),this.setControlValue("ctrl-wind-dir",t.windDir),this.setControlValue("ctrl-rain",t.rain),this.setControlValue("ctrl-fog",t.fog),this.setControlValue("ctrl-temp",t.temperature),this.setControlValue("ctrl-storm",t.storm),this.setControlValue("ctrl-hour",t.hourOverride),this.setControlValue("ctrl-persist",Math.max(2,Math.round(m.TEXT.LIFE_MIN/1e3))),this.setControlValue("ctrl-explosion",m.TEXT.PARTICLES_PER_LETTER),this.setControlValue("ctrl-ink-hue",m.TEXT._hueOverride||0),this.setControlValue("ctrl-font",m.TEXT.FONT_FAMILY),this.setControlValue("ctrl-font-size",m.TEXT.FONT_SIZE),this.setControlChecked("ctrl-rhythm-mute",!e.rhythm.muted),this.setControlValue("ctrl-rhythm-vol",e.rhythm.volume),this.setControlValue("ctrl-rhythm-attack",e.rhythm.attack),this.setControlValue("ctrl-rhythm-decay",e.rhythm.decay),this.setControlValue("ctrl-rhythm-release",e.rhythm.release),this.setControlChecked("ctrl-wind-mute",!e.wind.muted),this.setControlValue("ctrl-wind-vol",e.wind.volume),this.setControlChecked("ctrl-drone-mute",!e.drone.muted),this.setControlValue("ctrl-drone-vol",e.drone.volume),this.setControlValue("ctrl-drone-filter",e.drone.filterFreq),this.setControlValue("ctrl-drone-attack",e.drone.attack),this.setControlValue("ctrl-drone-release",e.drone.release),this.setControlValue("ctrl-drone-wave",e.drone.waveform),this.setControlChecked("ctrl-melody-mute",!e.melody.muted),this.setControlValue("ctrl-melody-vol",e.melody.volume),this.setControlValue("ctrl-melody-mode",e.melody.mode),this.setControlValue("ctrl-melody-wave",e.melody.waveform),this.setControlValue("ctrl-melody-attack",e.melody.attack),this.setControlValue("ctrl-melody-decay",e.melody.decay),this.setControlValue("ctrl-melody-release",e.melody.release),this.setControlValue("ctrl-melody-reverb",e.melody.reverb),this.pendingScaleSelection=this.sound.scaleMode||"auto",this.setControlValue("ctrl-auto-bpm",((i=this.app)==null?void 0:i.autoBPM)??m.AUTO.DEFAULT_BPM)}wireSlider(t,e,i){const r=document.getElementById(t),s=document.querySelector(`[data-for="${t}"]`);if(!r)return;const n=()=>{const o=parseFloat(r.value);e(o),s&&(s.textContent=i?i(o):o)};r.addEventListener("input",n),n()}wireToggle(t,e){const i=document.getElementById(t);if(!i)return;const r=()=>e(i.checked);i.addEventListener("change",r),r()}wireSelect(t,e){const i=document.getElementById(t);if(!i)return;const r=()=>e(i.value);i.addEventListener("change",r),r()}populateScaleSelector(t){const e=document.getElementById("ctrl-melody-scale");if(!e)return;const i=()=>{const r=t.getAvailableScales(),s=new Set(Array.from(e.options).map(h=>h.value));r.forEach(({key:h,label:l})=>{if(s.has(h))return;const a=document.createElement("option");a.value=h,a.textContent=l,e.appendChild(a)});const n=this.pendingScaleSelection||t.scaleMode||"auto",o=Array.from(e.options).some(h=>h.value===n);e.value=o?n:"auto",t.setScale(e.value)};if(t.scalesLoaded)i();else{const r=setInterval(()=>{t.scalesLoaded&&(clearInterval(r),i())},100);setTimeout(()=>{clearInterval(r),e.options.length<=1&&i()},3e3)}}wireFileImport(){const t=document.getElementById("file-import"),e=document.getElementById("btn-file-import");!t||!e||(e.addEventListener("click",()=>t.click()),t.addEventListener("change",i=>{const r=i.target.files[0];if(!r)return;const s=new FileReader;s.onload=n=>{const o=n.target.result;if(this.app){this.app.loadAutoText(o);const h=document.getElementById("auto-status");h&&(h.textContent=`${r.name} (${o.length} chars)`);const l=document.getElementById("btn-auto-play");l&&(l.textContent="‚è∏ Pausar")}},s.readAsText(r,"UTF-8")}))}togglePanel(t){const e=document.getElementById(t);e&&(document.querySelectorAll(".panel").forEach(i=>{i.id!==t&&i.classList.add("hidden")}),e.classList.toggle("hidden"))}closeAllPanels(){document.querySelectorAll(".panel").forEach(t=>t.classList.add("hidden"))}startClock(){const t=document.getElementById("clock");if(!t)return;const e=()=>{const i=new Date;t.textContent=`${String(i.getHours()).padStart(2,"0")}:${String(i.getMinutes()).padStart(2,"0")}:${String(i.getSeconds()).padStart(2,"0")}`};e(),setInterval(e,1e3)}togglePerformanceMode(){var i,r,s,n;this.performanceMode=!this.performanceMode;const t=["controls","panel-shortcuts","panel-about","clock"],e=document.querySelector(".floating-bar");this.performanceMode?(t.forEach(o=>{var h;return(h=document.getElementById(o))==null?void 0:h.classList.add("hidden")}),e&&(e.style.display="none"),(r=(i=document.documentElement).requestFullscreen)==null||r.call(i).catch(()=>{})):(e&&(e.style.display=""),(s=document.getElementById("clock"))==null||s.classList.remove("hidden"),document.fullscreenElement&&((n=document.exitFullscreen)==null||n.call(document).catch(()=>{})))}toggleFullscreen(){var t,e,i;document.fullscreenElement?(t=document.exitFullscreen)==null||t.call(document).catch(()=>{}):(i=(e=document.documentElement).requestFullscreen)==null||i.call(e).catch(()=>{})}captureScreenshot(t){const e=document.createElement("a");e.download=`text2wind_${Date.now()}.png`,e.href=t.toDataURL("image/png"),e.click()}}const it="text2wind_memory";class _t{constructor(){this.traces=[],this.revealTimer=0,this.agingLevel=0,this.accelerateTimer=0,this.loaded=!1}init(t){this.load()}load(){try{const t=localStorage.getItem(it);if(t){const e=JSON.parse(t);this.agingLevel=e.agingLevel||0,this.traces=e.traces||[],this.traces.length>500&&(this.traces=this.traces.slice(-500)),this.loaded=!0}}catch{}}save(){try{localStorage.setItem(it,JSON.stringify({agingLevel:this.agingLevel,traces:this.traces.slice(-200)}))}catch{}}recordLetter(t){this.traces.push({x:t.x,y:t.y,char:t.char,intensity:t.contemplated?.8:.4,timestamp:Date.now()}),this.agingLevel=I(this.agingLevel+.001,0,1),this.traces.length%20===0&&this.save()}reveal(t){this.revealTimer=t}accelerateAging(t){this.accelerateTimer=t}update(t,e){this.revealTimer>0&&(this.revealTimer-=t),this.accelerateTimer>0&&(this.accelerateTimer-=t,this.agingLevel=I(this.agingLevel+5e-4*t,0,1)),this.agingLevel=I(this.agingLevel+1e-6*t,0,1)}render(t,e,i,r){const s=r.cursor;this.agingLevel>.01&&(t.fillStyle=`rgba(30, 25, 15, ${this.agingLevel*.08})`,t.fillRect(0,0,e,i));const n=this.revealTimer>0;for(const o of this.traces){let h=0;if(n)h=o.intensity*.4*Math.min(this.revealTimer/1e3,1);else{const l=o.x-s.x,a=o.y-s.y,d=Math.sqrt(l*l+a*a);d<80&&(h=o.intensity*.3*(1-d/80))}h>.01&&(t.fillStyle=`rgba(180, 170, 140, ${h})`,t.font='28px "JetBrains Mono", monospace',t.fillText(o.char,o.x,o.y))}}}class Ft{constructor(){this.mode="contemplator",this.keyTimestamps=[],this.idleTime=0,this.wpm=0,this.blend={writer:0,contemplator:1,storm:0},this.suspensionTimer=0}init(t){}onKey(t){if(t.key.length===1){this.keyTimestamps.push(Date.now()),this.idleTime=0;const e=Date.now()-3e4;this.keyTimestamps=this.keyTimestamps.filter(i=>i>e)}}triggerSuspension(t){this.suspensionTimer=t}getMode(){return this.mode}getBlend(){return this.blend}isSuspended(){return this.suspensionTimer>0}update(t,e){if(this.idleTime+=t,this.suspensionTimer>0){this.suspensionTimer-=t;return}const i=Date.now()-15e3,r=this.keyTimestamps.filter(o=>o>i).length;this.wpm=r/5*4;const s=m.MODES;this.wpm>=s.STORM_WPM_THRESHOLD?this.mode="storm":this.wpm>=s.WRITER_WPM_THRESHOLD?this.mode="writer":this.idleTime>s.CONTEMPLATOR_IDLE&&(this.mode="contemplator");const n={writer:0,contemplator:0,storm:0};n[this.mode]=1;for(const o in this.blend)this.blend[o]=M(this.blend[o],n[o],.002*t)}}class Rt{constructor(){this.drops=[],this.maxDrops=2e3}init(t){}resize(t){}update(t,e){const i=e.weather.get("rain")/100;if(i<.05){this.drops=[];return}const r=window.innerWidth,s=window.innerHeight,n=e.weather.get("windDir"),o=e.weather.get("wind")/100,h=Math.floor(i*this.maxDrops);for(;this.drops.length<h;)this.drops.push({x:p(-50,r+50),y:p(-50,-10),speed:p(8,16)*(.5+i),length:p(10,25)*i,opacity:p(.1,.4)*i,windOffset:Math.sin(n*Math.PI/180)*o*3});for(let l=this.drops.length-1;l>=0;l--){const a=this.drops[l];a.y+=a.speed*t*.1,a.x+=a.windOffset*t*.05,a.y>s+20&&(this.drops.length>h?this.drops.splice(l,1):(a.y=p(-50,-10),a.x=p(-50,r+50)))}}render(t,e,i,r){if(this.drops.length===0)return;const s=r.weather.get("windDir")*Math.PI/180,n=Math.sin(s)*(r.weather.get("wind")/100)*10;t.strokeStyle="rgba(180, 200, 220, 0.3)",t.lineWidth=1;for(const o of this.drops)t.globalAlpha=o.opacity,t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(o.x+n,o.y+o.length),t.stroke();t.globalAlpha=1}}class Ot{constructor(){this.blades=[],this.lastTextTime=Date.now()}init(t){}update(t,e){var n;if((((n=e.text.letters)==null?void 0:n.length)||0)>0&&(this.lastTextTime=Date.now()),Date.now()-this.lastTextTime>m.GRASS.IDLE_THRESHOLD&&this.blades.length<m.GRASS.MAX_BLADES){const o=e.memory;if(o.traces.length>0){const h=o.traces[Math.floor(Math.random()*o.traces.length)];this.blades.push({x:h.x+p(-15,15),y:h.y+p(-5,5),height:0,maxHeight:p(m.GRASS.BLADE_HEIGHT_MIN,m.GRASS.BLADE_HEIGHT_MAX),width:p(1,3),growSpeed:p(.001,.003),phase:Math.random()*Math.PI*2})}else this.blades.push({x:p(40,window.innerWidth-40),y:p(window.innerHeight*.7,window.innerHeight-20),height:0,maxHeight:p(m.GRASS.BLADE_HEIGHT_MIN,m.GRASS.BLADE_HEIGHT_MAX),width:p(1,3),growSpeed:p(.001,.003),phase:Math.random()*Math.PI*2})}e.weather.get("wind")/100;for(const o of this.blades)o.height<o.maxHeight&&(o.height+=o.growSpeed*t)}render(t,e,i,r){if(this.blades.length===0)return;const s=Date.now()*.001,n=r.weather.get("wind")/100,o=r.weather.get("windDir"),h=r.weather.getCurrentHour(),l=h<6||h>20?1:h<8?(8-h)/2:h>18?(h-18)/2:0,a=m.GRASS.COLOR,d=Math.round(a[0]*(1-l*.6)*255),u=Math.round(a[1]*(1-l*.4)*255),S=Math.round(a[2]*(1-l*.5)*255);for(const c of this.blades){if(c.height<1)continue;const f=Math.sin(s*2+c.phase)*n*c.height*.3+Math.sin(o*.017)*n*c.height*.2,g=I(c.height/c.maxHeight,.3,.8);t.strokeStyle=`rgba(${d},${u},${S},${g})`,t.lineWidth=c.width,t.lineCap="round",t.beginPath(),t.moveTo(c.x,c.y),t.quadraticCurveTo(c.x+f*.5,c.y-c.height*.5,c.x+f,c.y-c.height),t.stroke()}}}class Nt{constructor(){this.flashTimer=0,this.flashIntensity=0,this.bolt=null}init(t){}update(t,e){var r,s;const i=e.weather.get("storm")/100;if(this.flashTimer>0){this.flashTimer-=t;return}i>.3&&Math.random()<i*3e-4*t&&(this.flash(i),(s=(r=e.sound)==null?void 0:r.playThunder)==null||s.call(r,i))}flash(t){this.flashTimer=150+t*200,this.flashIntensity=.3+t*.5;const e=window.innerWidth,i=p(e*.2,e*.8),r=[];let s=i,n=0;for(;n<window.innerHeight*.7;)s+=p(-30,30),n+=p(20,60),r.push({x:s,y:n});this.bolt=r}render(t,e,i,r){if(this.flashTimer<=0)return;const s=this.flashIntensity*(this.flashTimer/300);if(t.fillStyle=`rgba(220, 220, 255, ${s*.3})`,t.fillRect(0,0,e,i),this.bolt&&this.flashTimer>100){t.strokeStyle=`rgba(255, 255, 255, ${s})`,t.lineWidth=2,t.shadowColor="rgba(200, 200, 255, 0.8)",t.shadowBlur=15,t.beginPath(),t.moveTo(this.bolt[0].x,0);for(const n of this.bolt)t.lineTo(n.x,n.y);t.stroke(),t.shadowBlur=0}}}class Gt{constructor(){}init(t){}render(t,e,i,r){const s=r.weather.get("fog")/100;if(s<.05)return;const n=s*.5,o=r.weather.getCurrentHour(),h=o<6||o>20?1:o<8?(8-o)/2:o>18?(o-18)/2:0,l=h>.5?30:200,a=h>.5?30:195,d=h>.5?40:190,u=t.createLinearGradient(0,0,0,i);u.addColorStop(0,`rgba(${l},${a},${d},${n*.3})`),u.addColorStop(.6,`rgba(${l},${a},${d},${n*.5})`),u.addColorStop(1,`rgba(${l},${a},${d},${n*.8})`),t.fillStyle=u,t.fillRect(0,0,e,i)}}class Bt{constructor(){this.canvas=document.getElementById("world"),this.ctx=this.canvas.getContext("2d"),this.running=!1,this.started=!1,this.lastTime=0,this.sky=new wt,this.wind=new St,this.particles=new Tt,this.text=new Et,this.weather=new It,this.sound=new Pt,this.semantic=new At,this.cursor=new Ct,this.ui=new Dt,this.memory=new _t,this.modes=new Ft,this.rain=new Rt,this.grass=new Ot,this.lightning=new Nt,this.fog=new Gt,this.autoText=null,this.autoIndex=0,this.autoTimer=0,this.autoBPM=m.AUTO.DEFAULT_BPM,this.autoPlaying=!1,this.strokeInput={active:!1,pointerId:null,startX:0,startY:0,lastX:0,lastY:0,moved:!1},this.resize=this.resize.bind(this),this.loop=this.loop.bind(this),this.onKey=this.onKey.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this)}async init(){this.resize(),window.addEventListener("resize",this.resize),await this.semantic.load(),await this.sound.init().catch(i=>console.warn("Sound prewarm failed:",i));const t=this.getState();this.sky.init(t),this.wind.init(t),this.particles.init(t),this.text.init(t),this.weather.init(t),this.cursor.init(t),this.memory.init(t),this.modes.init(t),this.rain.init(t),this.grass.init(t),this.lightning.init(t),this.fog.init(t),this.ui.init(t,this.weather,this.sound,this),window.addEventListener("keydown",this.onKey),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("touchmove",i=>{i.touches.length>0&&this.cursor.update(i.touches[0].clientX,i.touches[0].clientY)}),this.canvas.addEventListener("pointerdown",this.onPointerDown,{passive:!1}),this.canvas.addEventListener("pointermove",this.onPointerMove,{passive:!1}),window.addEventListener("pointerup",this.onPointerUp,{passive:!1}),window.addEventListener("pointercancel",this.onPointerUp,{passive:!1}),this.canvas.addEventListener("touchstart",()=>{var i,r;return(r=(i=this.sound).primeFromGesture)==null?void 0:r.call(i)},{passive:!0}),this.canvas.addEventListener("click",i=>{if(!this.isMobileInput()){if(!this.started){this.startApp();return}i.target===this.canvas&&this.text.onCanvasClick(i.clientX,i.clientY,this.getState())}});const e=document.getElementById("intro");e.addEventListener("click",()=>this.startApp()),e.addEventListener("touchstart",()=>{var i,r;return(r=(i=this.sound).primeFromGesture)==null?void 0:r.call(i)},{passive:!0}),document.addEventListener("paste",i=>{if(!this.started||i.target.tagName==="INPUT"||i.target.tagName==="SELECT"||i.target.tagName==="TEXTAREA")return;i.preventDefault();const r=(i.clipboardData||window.clipboardData).getData("text");if(!r)return;const s=this.getState();for(const n of r)n===`
`?(this.text.checkWord(s),this.text.newLine()):n===" "?(this.text.addLetter(" ",s),this.text.checkWord(s)):n.length===1&&(this.text.addLetter(n,s),this.text.wordBuffer+=n.toLowerCase(),this.sound.onKey({key:n},this.weather))}),console.log("üåæ Text2Wind initialized")}startApp(){var t,e;this.started||(this.started=!0,this.running=!0,document.getElementById("intro").classList.add("hidden"),(e=(t=this.sound).primeFromGesture)==null||e.call(t),this.lastTime=performance.now(),requestAnimationFrame(this.loop),this.sound.enable().then(()=>{const i=document.getElementById("btn-sound");i&&(i.textContent="üîä")}).catch(()=>{const i=document.getElementById("btn-sound");i&&(i.textContent="üîá")}))}getState(){return{canvas:this.canvas,ctx:this.ctx,width:this.canvas.width,height:this.canvas.height,weather:this.weather,wind:this.wind,cursor:this.cursor,particles:this.particles,memory:this.memory,semantic:this.semantic,text:this.text,modes:this.modes,sound:this.sound}}resize(){const t=m.PIXEL_RATIO;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=window.innerWidth+"px",this.canvas.style.height=window.innerHeight+"px",this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t);const e=this.getState();this.sky.resize(e),this.particles.resize(e),this.text.resize(e),this.rain.resize(e)}onKey(t){var e;if(this.started){if(t.key==="F11"){t.preventDefault(),this.ui.togglePerformanceMode();return}if(t.key==="Escape"){this.ui.closeAllPanels(),document.fullscreenElement&&((e=document.exitFullscreen)==null||e.call(document));return}t.target.tagName==="INPUT"||t.target.tagName==="SELECT"||(this.sound.onKey(t,this.weather),this.text.onKey(t,this.getState()),this.modes.onKey(t))}}onMouseMove(t){this.cursor.update(t.clientX,t.clientY)}async ensureSoundEnabledFromGesture(){var t,e,i,r;if((e=(t=this.sound).primeFromGesture)==null||e.call(t),(i=this.sound)!=null&&i.enabled)return!0;try{await this.sound.enable();const s=document.getElementById("btn-sound");return s&&(s.textContent="üîä"),!!((r=this.sound)!=null&&r.enabled)}catch{const n=document.getElementById("btn-sound");return n&&(n.textContent="üîá"),!1}}isMobileInput(){return window.matchMedia("(pointer: coarse)").matches||(navigator.maxTouchPoints||0)>0}async onPointerDown(t){var s,n,o,h;if(!this.isMobileInput()||t.pointerType==="mouse"||t.target!==this.canvas||(this.started||this.startApp(),!this.started))return;t.cancelable&&t.preventDefault(),(n=(s=this.sound).primeFromGesture)==null||n.call(s),await this.ensureSoundEnabledFromGesture();const e=t.clientX,i=t.clientY,r=this.getState();this.cursor.update(e,i),this.text.onCanvasClick(e,i,r),this.strokeInput.active=!0,this.strokeInput.pointerId=t.pointerId,this.strokeInput.startX=e,this.strokeInput.startY=i,this.strokeInput.lastX=e,this.strokeInput.lastY=i,this.strokeInput.moved=!1,(h=(o=this.canvas).setPointerCapture)==null||h.call(o,t.pointerId)}onPointerMove(t){if(!this.strokeInput.active||t.pointerId!==this.strokeInput.pointerId||!this.isMobileInput()||t.pointerType==="mouse")return;t.cancelable&&t.preventDefault();const e=t.clientX,i=t.clientY;this.cursor.update(e,i);const r=e-this.strokeInput.startX,s=i-this.strokeInput.startY;Math.hypot(r,s)>6&&(this.strokeInput.moved=!0);const n=this.text.getStrokeSpacing(),o=e-this.strokeInput.lastX,h=i-this.strokeInput.lastY,l=Math.hypot(o,h);if(l<n)return;const a=Math.max(1,Math.floor(l/n)),d=this.getState(),u=o/a,S=h/a,c=l/a;for(let f=1;f<=a;f++){const g=f/a,y=this.strokeInput.lastX+o*g,T=this.strokeInput.lastY+h*g;this.text.addStrokePoint(y,T,d,{dx:u,dy:S,speed:c})}this.strokeInput.lastX=e,this.strokeInput.lastY=i}onPointerUp(t){var h,l;if(!this.strokeInput.active||t.pointerId!==this.strokeInput.pointerId||!this.isMobileInput()||t.pointerType==="mouse")return;t.cancelable&&t.preventDefault();const e=t.clientX,i=t.clientY;this.cursor.update(e,i);const r=this.text.getStrokeSpacing(),s=e-this.strokeInput.lastX,n=i-this.strokeInput.lastY,o=Math.hypot(s,n);if(o>r*.5){const a=this.getState();this.text.addStrokePoint(e,i,a,{dx:s,dy:n,speed:o})}this.strokeInput.active=!1,this.strokeInput.pointerId=null,(l=(h=this.canvas).releasePointerCapture)==null||l.call(h,t.pointerId)}loadAutoText(t){this.autoText=t,this.autoIndex=0,this.autoTimer=0,this.autoPlaying=!0,console.log(`üìñ Auto-typewriter: ${t.length} chars loaded`)}setAutoBPM(t){this.autoBPM=Math.max(10,Math.min(600,t))}toggleAutoPlay(){return this.autoText?(this.autoPlaying=!this.autoPlaying,this.autoPlaying):!1}stopAutoPlay(){this.autoPlaying=!1,this.autoText=null,this.autoIndex=0,this.autoTimer=0,this.text.wordBuffer=""}updateAutoTypewriter(t){if(!this.autoPlaying||!this.autoText||this.autoIndex>=this.autoText.length){this.autoText&&this.autoIndex>=this.autoText.length&&(this.autoPlaying=!1);return}this.autoTimer+=t;const e=6e4/this.autoBPM;if(this.autoTimer>=e){this.autoTimer-=e;const i=this.autoText[this.autoIndex],r=this.getState();i===`
`?(this.text.checkWord(r),this.text.newLine()):i===" "?(this.text.addLetter(" ",r),this.text.checkWord(r)):(this.text.addLetter(i,r),this.text.wordBuffer+=i.toLowerCase(),this.sound.onKey({key:i},this.weather)),this.autoIndex++}}loop(t){if(!this.running)return;const e=Math.min(t-this.lastTime,50);this.lastTime=t;const i=this.getState(),r=window.innerWidth,s=window.innerHeight,n=this.weather.getCurrentHour();this.weather.update(e,i),this.wind.update(e,i),this.modes.update(e,i),this.text.update(e,i),this.particles.update(e,i),this.grass.update(e,i),this.rain.update(e,i),this.lightning.update(e,i),this.memory.update(e,i),this.sound.update(e,i),this.updateAutoTypewriter(e),this.ctx.save(),this.sky.render(this.ctx,r,s,n,this.weather),this.memory.render(this.ctx,r,s,i),this.grass.render(this.ctx,r,s,i),this.text.render(this.ctx,r,s,i),this.particles.render(this.ctx,r,s,i),this.rain.render(this.ctx,r,s,i),this.lightning.render(this.ctx,r,s,i),this.fog.render(this.ctx,r,s,i),this.cursor.render(this.ctx,r,s,n),this.ctx.restore(),requestAnimationFrame(this.loop)}}const Ht=new Bt;Ht.init().catch(w=>console.error("Text2Wind init error:",w));
