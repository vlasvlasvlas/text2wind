(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const e of r)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function i(r){const e={};return r.integrity&&(e.integrity=r.integrity),r.referrerPolicy&&(e.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?e.credentials="include":r.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(r){if(r.ep)return;r.ep=!0;const e=i(r);fetch(r.href,e)}})();const m={PIXEL_RATIO:Math.min(window.devicePixelRatio,2),SKY_PALETTES:[{hour:0,top:[.02,.02,.06],bottom:[.04,.03,.1]},{hour:4,top:[.04,.04,.14],bottom:[.08,.06,.18]},{hour:5.5,top:[.12,.08,.22],bottom:[.4,.18,.25]},{hour:6.5,top:[.3,.25,.5],bottom:[.85,.45,.25]},{hour:8,top:[.35,.55,.85],bottom:[.65,.75,.9]},{hour:12,top:[.42,.62,.92],bottom:[.7,.82,.95]},{hour:16,top:[.4,.55,.82],bottom:[.75,.7,.65]},{hour:18,top:[.3,.2,.5],bottom:[.9,.4,.2]},{hour:19.5,top:[.15,.08,.35],bottom:[.5,.15,.3]},{hour:21,top:[.04,.03,.12],bottom:[.08,.05,.16]},{hour:24,top:[.02,.02,.06],bottom:[.04,.03,.1]}],TEXT:{FONT_FAMILY:"'JetBrains Mono', monospace",FONT_SIZE:28,LINE_HEIGHT:42,INK_COLOR_DAY:[.15,.12,.1],INK_COLOR_NIGHT:[.85,.8,.72],BIRTH_DURATION:400,LIFE_MIN:8e3,LIFE_MAX:16e3,EROSION_DURATION:4e3,PARTICLES_PER_LETTER:60,_hueOverride:0},WIND:{DEFAULT_INTENSITY:20,DEFAULT_DIRECTION:90,NOISE_SCALE:.003,NOISE_SPEED:4e-4,TURBULENCE_OCTAVES:3},PARTICLES:{MAX_COUNT:1e4,DEFAULT_LIFE:4e3,MIN_SIZE:1,MAX_SIZE:4,GRAVITY:.02},WEATHER:{TRANSITION_SPEED:.005},CURSOR:{LIGHT_RADIUS:120,GLOW_COLOR:[1,.85,.55],GLOW_INTENSITY:.6},GRASS:{IDLE_THRESHOLD:3e4,MAX_BLADES:500,BLADE_HEIGHT_MIN:8,BLADE_HEIGHT_MAX:30,COLOR:[.25,.55,.2]},MODES:{WRITER_WPM_THRESHOLD:5,STORM_WPM_THRESHOLD:60,CONTEMPLATOR_IDLE:5e3}};function L(y,t,i){return y+(t-y)*i}function b(y,t,i){return Math.max(t,Math.min(i,y))}function rt(y,t,i){const s=b((i-y)/(t-y),0,1);return s*s*(3-2*s)}function Z(y,t,i){return[L(y[0],t[0],i),L(y[1],t[1],i),L(y[2],t[2],i)]}function nt(y){return y*(Math.PI/180)}function f(y,t){return y+Math.random()*(t-y)}function ot(y){return 1-Math.pow(1-y,3)}function at(y,t,i,s){const r=i-y,e=s-t;return Math.sqrt(r*r+e*e)}const ht=.5*(Math.sqrt(3)-1),$=(3-Math.sqrt(3))/6,lt=1/3,A=1/6;class ct{constructor(t=Math.random()){this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);const i=new Uint8Array(256);for(let r=0;r<256;r++)i[r]=r;let s=t*2147483647;s<=0&&(s+=2147483646);for(let r=255;r>0;r--){s=s*16807%2147483647;const e=s%(r+1);[i[r],i[e]]=[i[e],i[r]]}for(let r=0;r<512;r++)this.perm[r]=i[r&255],this.permMod12[r]=this.perm[r]%12}dot2(t,i,s){return t[0]*i+t[1]*s}dot3(t,i,s,r){return t[0]*i+t[1]*s+t[2]*r}noise2D(t,i){const s=(t+i)*ht,r=Math.floor(t+s),e=Math.floor(i+s),n=(r+e)*$,o=r-n,h=e-n,l=t-o,a=i-h;let u,d;l>a?(u=1,d=0):(u=0,d=1);const T=l-u+$,c=a-d+$,p=l-1+2*$,w=a-1+2*$,g=r&255,S=e&255,E=this.permMod12[g+this.perm[S]],v=this.permMod12[g+u+this.perm[S+d]],M=this.permMod12[g+1+this.perm[S+1]];let x=0,P=0,_=0,k=.5-l*l-a*a;k>=0&&(k*=k,x=k*k*this.dot2(this.grad3[E],l,a));let R=.5-T*T-c*c;R>=0&&(R*=R,P=R*R*this.dot2(this.grad3[v],T,c));let C=.5-p*p-w*w;return C>=0&&(C*=C,_=C*C*this.dot2(this.grad3[M],p,w)),70*(x+P+_)}noise3D(t,i,s){const r=(t+i+s)*lt,e=Math.floor(t+r),n=Math.floor(i+r),o=Math.floor(s+r),h=(e+n+o)*A,l=e-h,a=n-h,u=o-h,d=t-l,T=i-a,c=s-u;let p,w,g,S,E,v;d>=T?T>=c?(p=1,w=0,g=0,S=1,E=1,v=0):d>=c?(p=1,w=0,g=0,S=1,E=0,v=1):(p=0,w=0,g=1,S=1,E=0,v=1):T<c?(p=0,w=0,g=1,S=0,E=1,v=1):d<c?(p=0,w=1,g=0,S=0,E=1,v=1):(p=0,w=1,g=0,S=1,E=1,v=0);const M=d-p+A,x=T-w+A,P=c-g+A,_=d-S+2*A,k=T-E+2*A,R=c-v+2*A,C=d-1+3*A,W=T-1+3*A,q=c-1+3*A,B=e&255,H=n&255,X=o&255,tt=this.permMod12[B+this.perm[H+this.perm[X]]],et=this.permMod12[B+p+this.perm[H+w+this.perm[X+g]]],it=this.permMod12[B+S+this.perm[H+E+this.perm[X+v]]],st=this.permMod12[B+1+this.perm[H+1+this.perm[X+1]]];let U=0,Y=0,K=0,j=0,O=.6-d*d-T*T-c*c;O>=0&&(O*=O,U=O*O*this.dot3(this.grad3[tt],d,T,c));let D=.6-M*M-x*x-P*P;D>=0&&(D*=D,Y=D*D*this.dot3(this.grad3[et],M,x,P));let N=.6-_*_-k*k-R*R;N>=0&&(N*=N,K=N*N*this.dot3(this.grad3[it],_,k,R));let F=.6-C*C-W*W-q*q;return F>=0&&(F*=F,j=F*F*this.dot3(this.grad3[st],C,W,q)),32*(U+Y+K+j)}fbm2D(t,i,s=3,r=2,e=.5){let n=0,o=1,h=1,l=0;for(let a=0;a<s;a++)n+=this.noise2D(t*h,i*h)*o,l+=o,o*=e,h*=r;return n/l}fbm3D(t,i,s,r=3,e=2,n=.5){let o=0,h=1,l=1,a=0;for(let u=0;u<r;u++)o+=this.noise3D(t*l,i*l,s*l)*h,a+=h,h*=n,l*=e;return o/a}}const G=new ct(42);class dt{constructor(){this.starField=[],this.cloudOffset=0,this.cloudCanvas=null,this.cloudCtx=null,this.cloudNeedsUpdate=!0,this.cloudUpdateTimer=0,this.cloudPuffs=[]}init(t){this.starField=[];for(let i=0;i<200;i++)this.starField.push({x:Math.random(),y:Math.random()*.7,size:.5+Math.random()*1.5,flicker:Math.random()*Math.PI*2,speed:.5+Math.random()*2});this.cloudCanvas=document.createElement("canvas"),this.cloudCtx=this.cloudCanvas.getContext("2d"),this.generateCloudFormations()}generateCloudFormations(){this.cloudPuffs=[];const t=12;for(let i=0;i<t;i++){const s=f(0,1.4)-.2,r=f(.05,.4),e=f(.06,.18),n=Math.floor(f(5,15)),o=Math.floor(f(0,3));for(let h=0;h<n;h++){const l=f(0,Math.PI*2),a=f(0,e*.7);this.cloudPuffs.push({x:s+Math.cos(l)*a,y:r+Math.sin(l)*a*.5,radius:f(e*.3,e*.9),opacity:f(.15,.5),layer:o,noisePhase:f(0,100)})}}this.cloudPuffs.sort((i,s)=>i.layer-s.layer)}resize(t){this.cloudCanvas&&(this.cloudCanvas.width=Math.floor(window.innerWidth*.5),this.cloudCanvas.height=Math.floor(window.innerHeight*.5))}getColorsForHour(t){const i=m.SKY_PALETTES;let s=i[0],r=i[1];for(let h=0;h<i.length-1;h++)if(t>=i[h].hour&&t<i[h+1].hour){s=i[h],r=i[h+1];break}const e=r.hour-s.hour,n=e>0?(t-s.hour)/e:0,o=rt(0,1,n);return{top:Z(s.top,r.top,o),bottom:Z(s.bottom,r.bottom,o)}}render(t,i,s,r,e){const n=this.getColorsForHour(r),o=e.get("storm")/100,h=e.get("fog")/100,l=e.get("rain")/100,a=o*.5,u=l*.2;let d=b((n.top[0]-a-u)*255,0,255),T=b((n.top[1]-a-u)*255,0,255),c=b((n.top[2]-a*.3)*255,0,255),p=b((n.bottom[0]-a-u)*255,0,255),w=b((n.bottom[1]-a-u)*255,0,255),g=b((n.bottom[2]-a*.3)*255,0,255);const S=t.createLinearGradient(0,0,0,s);S.addColorStop(0,`rgb(${d},${T},${c})`),S.addColorStop(1,`rgb(${p},${w},${g})`),t.fillStyle=S,t.fillRect(0,0,i,s);const E=this.getNightness(r);E>.05&&this.renderStars(t,i,s,E,h);const v=b(l*.7+o*.9+h*.3+.1,0,1);v>.05&&this.renderClouds(t,i,s,r,v,e),this.renderWindParticles(t,i,s,e)}getNightness(t){return t<5?1:t<7?1-(t-5)/2:t<18?0:t<20?(t-18)/2:1}renderStars(t,i,s,r,e){const n=r*(1-e*.8);if(n<.02)return;const o=Date.now()*.001;for(const h of this.starField){const l=.5+.5*Math.sin(o*h.speed+h.flicker),a=n*l*.8;a<.02||(t.fillStyle=`rgba(220, 215, 200, ${a})`,t.beginPath(),t.arc(h.x*i,h.y*s,h.size,0,Math.PI*2),t.fill())}}renderClouds(t,i,s,r,e,n){const o=Date.now()*5e-5,h=n.get("wind")/100;this.cloudOffset+=h*3e-4;const l=this.getNightness(r),a=n.get("storm")/100;let u,d,T;l>.5?(u=L(60,30,a),d=L(60,30,a),T=L(75,40,a)):(u=L(240,120,a),d=L(240,115,a),T=L(250,130,a)),t.save();for(const c of this.cloudPuffs){const p=G.noise2D(c.noisePhase+o*2,0)*.02,w=G.noise2D(0,c.noisePhase+o*1.5)*.01,g=(c.x+this.cloudOffset*(1+c.layer*.3)+p)%1.6-.2,S=c.y+w,E=g*i,v=S*s,M=c.radius*Math.min(i,s);if(E<-M*2||E>i+M*2||v<-M*2||v>s)continue;const x=c.opacity*e*(.4+a*.4),P=t.createRadialGradient(E,v,M*.1,E,v,M);P.addColorStop(0,`rgba(${u},${d},${T},${x})`),P.addColorStop(.4,`rgba(${u},${d},${T},${x*.6})`),P.addColorStop(.7,`rgba(${u},${d},${T},${x*.2})`),P.addColorStop(1,`rgba(${u},${d},${T},0)`),t.fillStyle=P,t.beginPath(),t.arc(E,v,M,0,Math.PI*2),t.fill()}t.restore()}renderWindParticles(t,i,s,r){const e=r.get("wind")/100;if(e<.05)return;if(!this._windMotes){this._windMotes=[];for(let w=0;w<300;w++)this._windMotes.push({x:Math.random()*i,y:Math.random()*s,size:f(.5,2.5),speed:f(.3,1),opacity:f(.05,.2),phase:Math.random()*Math.PI*2,drift:f(-.3,.3)})}const n=r.get("windDir")*Math.PI/180,o=Math.cos(n),h=Math.sin(n),l=Date.now()*.001,a=r.getCurrentHour(),u=this.getNightness(a),d=Math.floor(e*300),T=u>.5?160:220,c=u>.5?155:215,p=u>.5?170:200;for(let w=0;w<d&&w<this._windMotes.length;w++){const g=this._windMotes[w],S=Math.sin(l*.5+g.phase)*g.drift;g.x+=o*e*g.speed*2+S,g.y+=h*e*g.speed*2+Math.sin(l+g.phase)*.2,g.x>i+10&&(g.x=-10),g.x<-10&&(g.x=i+10),g.y>s+10&&(g.y=-10),g.y<-10&&(g.y=s+10);const E=g.opacity*e;E<.01||(t.fillStyle=`rgba(${T},${c},${p},${E})`,t.beginPath(),t.arc(g.x,g.y,g.size,0,Math.PI*2),t.fill())}}}class ut{constructor(){this.intensity=m.WIND.DEFAULT_INTENSITY,this.direction=m.WIND.DEFAULT_DIRECTION,this.time=0}init(t){}setIntensity(t){this.intensity=b(t,0,100)}setDirection(t){this.direction=t%360}update(t,i){this.time+=t*m.WIND.NOISE_SPEED;const s=i.weather;this.intensity=s.get("wind"),this.direction=s.get("windDir")}getForceAt(t,i){const s=m.WIND.NOISE_SCALE,r=m.WIND.TURBULENCE_OCTAVES,e=this.intensity/100,n=nt(this.direction),o=Math.cos(n)*e,h=Math.sin(n)*e,l=G.fbm3D(t*s,i*s,this.time,r),a=G.fbm3D(t*s+100,i*s+100,this.time,r),u=e*.6;return{fx:o+l*u,fy:h+a*u}}getSpeedAt(t,i){const s=this.getForceAt(t,i);return Math.sqrt(s.fx*s.fx+s.fy*s.fy)}}class mt{constructor(){this.pool=[],this.activeCount=0}init(t){this.pool=new Array(m.PARTICLES.MAX_COUNT);for(let i=0;i<this.pool.length;i++)this.pool[i]={active:!1,x:0,y:0,vx:0,vy:0,life:0,maxLife:0,size:1,r:200,g:190,b:170,opacity:1,type:"dust"};this.activeCount=0}resize(t){}emit(t,i,s,r={}){const{color:e=[200,190,170],sizeMin:n=m.PARTICLES.MIN_SIZE,sizeMax:o=m.PARTICLES.MAX_SIZE,life:h=m.PARTICLES.DEFAULT_LIFE,spread:l=30,velocityScale:a=1,type:u="dust"}=r;let d=0;for(let T=0;T<this.pool.length&&d<s;T++){const c=this.pool[T];c.active||(c.active=!0,c.x=t+f(-l*.3,l*.3),c.y=i+f(-l*.3,l*.3),c.vx=f(-l,l)*.02*a,c.vy=f(-l,l)*.02*a,c.life=h+f(-h*.3,h*.3),c.maxLife=c.life,c.size=f(n,o),c.r=e[0],c.g=e[1],c.b=e[2],c.opacity=1,c.type=u,d++,this.activeCount++)}return d}update(t,i){const s=i.wind,r=m.PARTICLES.GRAVITY;this.activeCount=0;for(let e=0;e<this.pool.length;e++){const n=this.pool[e];if(!n.active)continue;if(n.life-=t,n.life<=0){n.active=!1;continue}this.activeCount++;const o=n.life/n.maxLife;n.opacity=Math.min(o*3,1);const h=s.getForceAt(n.x,n.y);n.vx+=h.fx*t*.005,n.vy+=h.fy*t*.005,n.vy+=r*t*.01,n.vx*=.998,n.vy*=.998,n.x+=n.vx*t*.1,n.y+=n.vy*t*.1,n.size*=1-1e-4*t}}render(t,i,s,r){for(let e=0;e<this.pool.length;e++){const n=this.pool[e];if(!n.active)continue;if(n.x<-20||n.x>i+20||n.y<-20||n.y>s+20){n.active=!1,this.activeCount--;continue}const o=b(n.opacity,0,1);o<.01||(t.fillStyle=`rgba(${n.r},${n.g},${n.b},${o})`,t.beginPath(),t.arc(n.x,n.y,n.size,0,Math.PI*2),t.fill())}}}const I={BIRTH:"birth",LIFE:"life",EROSION:"erosion",DEAD:"dead"};class ft{constructor(){this.letters=[],this.writeX=100,this.writeY=100,this.cursorBlink=0,this.lineHeight=m.TEXT.LINE_HEIGHT,this.wordBuffer="",this.lineStartX=100}init(t){}resize(t){}onCanvasClick(t,i,s){this.writeX=t,this.writeY=i,this.lineStartX=t,this.wordBuffer.length>0&&this.checkWord(s),this.wordBuffer=""}onKey(t,i){const s=t.key;if(s==="Enter"){t.preventDefault(),this.checkWord(i),this.accelerateErosion(i),this.newLine();return}if(s===" "){this.addLetter(" ",i),this.checkWord(i);return}if(s==="Backspace"){this.eraseLastLetter(i);return}s.length===1&&!t.ctrlKey&&!t.metaKey&&(this.addLetter(s,i),this.wordBuffer+=s.toLowerCase())}eraseLastLetter(t){var i,s;for(let r=this.letters.length-1;r>=0;r--){const e=this.letters[r];if(e.phase===I.LIFE||e.phase===I.BIRTH){e.phase=I.EROSION,e.erosionTimer=0,e.maxErosion=m.TEXT.EROSION_DURATION*.3;const n=t.ctx;n.font=`${m.TEXT.FONT_SIZE}px ${m.TEXT.FONT_FAMILY}`,this.writeX-=n.measureText(e.char).width+2,(s=(i=t.sound)==null?void 0:i.onLetterErosion)==null||s.call(i,e);break}}this.wordBuffer.length>0&&(this.wordBuffer=this.wordBuffer.slice(0,-1))}accelerateErosion(t){var e,n;const i=this.writeY,s=this.lineHeight*.6;let r=0;for(const o of this.letters)Math.abs(o.y-i)<s&&(o.phase===I.LIFE||o.phase===I.BIRTH)&&(o.phase=I.EROSION,o.erosionTimer=-r*80,o.maxErosion=m.TEXT.EROSION_DURATION*(.3+Math.random()*.4),r++,(n=(e=t.sound)==null?void 0:e.onLetterErosion)==null||n.call(e,o))}checkWord(t){if(this.wordBuffer.length>=2){const i=this.wordBuffer.trim();if(i){const s=t.semantic.lookup(i);s&&(t.weather.applySemanticEffects(s.effects,i),s.special&&this.triggerSpecialEffect(s.special,t),this.markWordForContemplation(i))}}this.wordBuffer=""}markWordForContemplation(t){let i=0;for(let s=this.letters.length-1;s>=0&&i<t.length+1;s--){const r=this.letters[s];r.phase!==I.DEAD&&r.char!==" "&&(r.contemplated=!0,r.contemplateTime=2e3,i++)}}triggerSpecialEffect(t,i){switch(t.effect){case"gleaning_mode":i.particles.emit(window.innerWidth*.5,window.innerHeight*.9,200,{spread:window.innerWidth*.4,life:5e3,velocityScale:-2});break;case"palimpsest_reveal":i.memory.reveal(3e3);break;case"suspension":i.modes.triggerSuspension(5e3);break;case"time_lapse":i.weather.triggerTimeLapse(6);break;case"heart_formation":this.emitHeartParticles(i);break;case"erosion_burst":this.erodeAllLetters(i);break;case"rapid_aging":i.memory.accelerateAging(5e3);break;case"full_reveal":i.memory.reveal(8e3),i.modes.triggerSuspension(8e3);break}}emitHeartParticles(t){const i=window.innerWidth*.5,s=window.innerHeight*.4;for(let r=0;r<Math.PI*2;r+=.05){const e=i+960*Math.pow(Math.sin(r),3),n=s-60*(13*Math.cos(r)-5*Math.cos(2*r)-2*Math.cos(3*r)-Math.cos(4*r));t.particles.emit(i+(e-i)*.18,s+(n-s)*.18,1,{color:[220,120,130],life:4e3,sizeMin:2,sizeMax:4})}}erodeAllLetters(t){var s,r;let i=0;for(const e of this.letters)(e.phase===I.LIFE||e.phase===I.BIRTH)&&(e.phase=I.EROSION,e.erosionTimer=-i*30,i++,(r=(s=t.sound)==null?void 0:s.onLetterErosion)==null||r.call(s,e))}addLetter(t,i){const s=window.innerWidth;this.writeX>s-60&&this.newLine();const r={char:t,x:this.writeX,y:this.writeY,phase:I.BIRTH,birthTimer:0,lifeTimer:0,erosionTimer:0,maxLife:m.TEXT.LIFE_MIN+f(0,m.TEXT.LIFE_MAX),maxErosion:m.TEXT.EROSION_DURATION,opacity:0,scale:1,vx:0,vy:0,contemplated:!1,contemplateTime:0,shakex:0,shakey:0};this.letters.push(r);const e=i.ctx;e.font=`${m.TEXT.FONT_SIZE}px ${m.TEXT.FONT_FAMILY}`,this.writeX+=e.measureText(t).width+2,this.cursorBlink=0}newLine(){this.writeX=this.lineStartX,this.writeY+=this.lineHeight;const t=window.innerHeight-60;if(this.writeY>t){const i=this.lineHeight;this.writeY-=i;for(const s of this.letters)s.y-=i}}update(t,i){var o,h;const s=i.cursor,r=i.wind,e=i.weather,n=e.get("wind")/100;for(let l=this.letters.length-1;l>=0;l--){const a=this.letters[l];if(a.phase===I.DEAD){i.memory.recordLetter(a),this.letters.splice(l,1);continue}const d=at(a.x,a.y,s.x,s.y)<m.CURSOR.LIGHT_RADIUS;switch(a.phase){case I.BIRTH:a.birthTimer+=t,a.opacity=ot(b(a.birthTimer/m.TEXT.BIRTH_DURATION,0,1)),a.birthTimer>=m.TEXT.BIRTH_DURATION&&(a.phase=I.LIFE,a.opacity=1);break;case I.LIFE:if(a.contemplated&&a.contemplateTime>0){a.contemplateTime-=t,a.scale=1+Math.sin(Date.now()*.005)*.03;break}d||(a.lifeTimer+=t),a.scale=1+Math.sin(Date.now()*.002+a.x)*.01;const c=a.lifeTimer/a.maxLife;if(c>.7){const S=(c-.7)/.3;a.shakex=(Math.random()-.5)*S*3*(1+n*2),a.shakey=(Math.random()-.5)*S*2}a.lifeTimer>=a.maxLife*(1-n*.5)&&(a.phase=I.EROSION,a.erosionTimer=0,(h=(o=i.sound)==null?void 0:o.onLetterErosion)==null||h.call(o,a));break;case I.EROSION:if(a.erosionTimer+=t,a.erosionTimer<0)break;const p=a.maxErosion||m.TEXT.EROSION_DURATION,w=a.erosionTimer/p;a.opacity=1-w,a.shakex=(Math.random()-.5)*4*(1+n*3),a.shakey=(Math.random()-.5)*3;const g=r.getForceAt(a.x,a.y);a.vx+=g.fx*t*.003,a.vy+=g.fy*t*.003,a.x+=a.vx,a.y+=a.vy,w>.2&&Math.random()<.15&&i.particles.emit(a.x,a.y,2,{color:this.getInkColor(e.getCurrentHour()),spread:10+n*30,life:3e3+n*4e3,sizeMin:1,sizeMax:3}),w>=1&&(i.particles.emit(a.x,a.y,m.TEXT.PARTICLES_PER_LETTER,{color:this.getInkColor(e.getCurrentHour()),spread:20+n*40,life:4e3}),a.phase=I.DEAD);break}const T=e.get("rain")/100;T>.3&&a.phase===I.LIFE&&(a.y+=T*.02*t*.01,a.opacity*=1-T*1e-4*t,a.opacity<.05&&(a.phase=I.DEAD))}this.cursorBlink+=t}getInkColor(t){const i=t<6||t>20?1:t<8?(8-t)/2:t>18?(t-18)/2:0,s=m.TEXT.INK_COLOR_DAY.map(e=>e*255),r=m.TEXT.INK_COLOR_NIGHT.map(e=>e*255);return[Math.round(s[0]+(r[0]-s[0])*i),Math.round(s[1]+(r[1]-s[1])*i),Math.round(s[2]+(r[2]-s[2])*i)]}render(t,i,s,r){const e=r.weather.getCurrentHour(),n=m.TEXT._hueOverride||0,o=n>0?this.hueToRGB(n,e):this.getInkColor(e);t.font=`${m.TEXT.FONT_SIZE}px ${m.TEXT.FONT_FAMILY}`,t.textBaseline="top";for(const h of this.letters)h.phase===I.DEAD||h.opacity<.01||(t.save(),t.translate(h.x+h.shakex,h.y+h.shakey),t.scale(h.scale,h.scale),h.contemplated&&h.contemplateTime>0&&(t.shadowColor="rgba(255,220,150,0.5)",t.shadowBlur=8),t.fillStyle=`rgba(${o[0]},${o[1]},${o[2]},${h.opacity})`,t.fillText(h.char,0,0),t.shadowBlur=0,t.restore());Math.sin(this.cursorBlink*.003)>0&&(t.fillStyle=`rgba(${o[0]},${o[1]},${o[2]},0.5)`,t.fillRect(this.writeX,this.writeY,2,m.TEXT.FONT_SIZE))}hueToRGB(t,i){const r=i<6||i>20?.78:.25,e=.6,n=t/360,o=r<.5?r*(1+e):r+e-r*e,h=2*r-o,l=(a,u,d)=>(d<0&&(d+=1),d>1&&(d-=1),d<1/6?a+(u-a)*6*d:d<1/2?u:d<2/3?a+(u-a)*(2/3-d)*6:a);return[Math.round(l(h,o,n+1/3)*255),Math.round(l(h,o,n)*255),Math.round(l(h,o,n-1/3)*255)]}}class pt{constructor(){this.current={wind:m.WIND.DEFAULT_INTENSITY,windDir:m.WIND.DEFAULT_DIRECTION,rain:0,fog:0,temperature:20,storm:0,snow:0,hourOverride:-1},this.target={...this.current},this.semanticPush={temperature:0,heat_haze:0,snow:0,wind_intensity:0,storm:0,rain:0,fog:0,letter_life:0,hour_shift:0,luminosity:0},this.timeLapse=null}init(t){}get(t){return this.current[t]??0}set(t,i){this.target[t]=i}getCurrentHour(){const t=new Date;let i=t.getHours()+t.getMinutes()/60;return this.current.hourOverride>=0&&this.current.hourOverride<=24&&(i=this.current.hourOverride),i+=this.semanticPush.hour_shift*2,this.timeLapse&&(i=this.timeLapse.currentHour),(i%24+24)%24}applySemanticEffects(t,i){for(const[s,r]of Object.entries(t))s in this.semanticPush&&(this.semanticPush[s]+=r*.3);this.target.rain=b(this.target.rain+this.semanticPush.rain*20,0,100),this.target.wind=b(this.target.wind+this.semanticPush.wind_intensity*15,0,100),this.target.storm=b(this.target.storm+this.semanticPush.storm*20,0,100),this.target.fog=b(this.target.fog+this.semanticPush.fog*25,0,100),this.target.temperature=b(this.target.temperature+this.semanticPush.temperature*5,-10,45)}triggerTimeLapse(t){const i=this.getCurrentHour();this.timeLapse={startHour:i,targetHour:(i+t)%24,currentHour:i,progress:0,duration:5e3}}update(t,i){var r,e;const s=m.WEATHER.TRANSITION_SPEED;for(const n in this.current)n!=="hourOverride"&&(this.current[n]=L(this.current[n],this.target[n],s*t*.06));this.current.hourOverride=this.target.hourOverride;for(const n in this.semanticPush)this.semanticPush[n]*=.999;if(this.timeLapse)if(this.timeLapse.progress+=t/this.timeLapse.duration,this.timeLapse.progress>=1)this.timeLapse=null;else{const n=this.timeLapse.progress;this.timeLapse.currentHour=L(this.timeLapse.startHour,this.timeLapse.targetHour,n)}this.current.storm>40&&Math.random()<this.current.storm*5e-5*t&&((e=(r=i.sound)==null?void 0:r.playThunder)==null||e.call(r,this.current.storm/100))}}const yt="modulepreload",gt=function(y,t){return new URL(y,t).href},V={},wt=function(t,i,s){let r=Promise.resolve();if(i&&i.length>0){let n=function(a){return Promise.all(a.map(u=>Promise.resolve(u).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};const o=document.getElementsByTagName("link"),h=document.querySelector("meta[property=csp-nonce]"),l=(h==null?void 0:h.nonce)||(h==null?void 0:h.getAttribute("nonce"));r=n(i.map(a=>{if(a=gt(a,s),a in V)return;V[a]=!0;const u=a.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(!!s)for(let p=o.length-1;p>=0;p--){const w=o[p];if(w.href===a&&(!u||w.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${d}`))return;const c=document.createElement("link");if(c.rel=u?"stylesheet":yt,u||(c.as="script"),c.crossOrigin="",c.href=a,l&&c.setAttribute("nonce",l),document.head.appendChild(c),u)return new Promise((p,w)=>{c.addEventListener("load",p),c.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${a}`)))})}))}function e(n){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=n,window.dispatchEvent(o),!o.defaultPrevented)throw n}return r.then(n=>{for(const o of n||[])o.status==="rejected"&&e(o.reason);return t().catch(e)})},J={aeolian:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],pentatonic:[0,2,4,7,9],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]},Tt={z:48,s:49,x:50,d:51,c:52,v:53,g:54,b:55,h:56,n:57,j:58,m:59,q:60,2:61,w:62,3:63,e:64,r:65,5:66,t:67,6:68,y:69,7:70,u:71,i:72,9:73,o:74,0:75,p:76},z={0:"C2",4:"D2",6:"E2",8:"G2",12:"A2",16:"F2",18:"E2",20:"D2",22:"C2"};class St{constructor(){this.initialized=!1,this.enabled=!1,this.Tone=null,this.params={rhythm:{volume:-14,muted:!1,waveform:"membrane",attack:.002,decay:.15,release:.1},drone:{volume:-22,muted:!1,waveform:"sine",attack:4,release:6,filterFreq:400},melody:{volume:-16,muted:!1,waveform:"triangle",attack:.05,decay:.6,release:1.5,mode:"random",reverb:.35},wind:{volume:-35,muted:!1}},this.currentScale="pentatonic",this.droneFreq=65.41,this.lastNoteTime=0,this.noteIndex=0,this.rhythmSynth=null,this.rhythmNoiseSynth=null,this.droneSynth=null,this.droneFilter=null,this.melodySynth=null,this.windNoise=null,this.windGain=null,this.masterGain=null,this.reverb=null,this.delay=null,this.thunderSynth=null,this.rainSynth=null}async init(){try{this.Tone=await wt(()=>import("./index-Cvny4KXv.js"),[],import.meta.url)}catch{console.warn("‚ö†Ô∏è Tone.js not available, sound disabled");return}}async enable(){if(!this.Tone&&(await this.init(),!this.Tone))return;const t=this.Tone;await t.start(),this.reverb=new t.Reverb({decay:6,wet:this.params.melody.reverb}).toDestination(),this.delay=new t.FeedbackDelay({delayTime:"8n",feedback:.2,wet:.15}).connect(this.reverb),this.masterGain=new t.Gain(.8).connect(this.delay),this.rhythmSynth=new t.MembraneSynth({pitchDecay:.08,octaves:3,envelope:{attack:this.params.rhythm.attack,decay:this.params.rhythm.decay,sustain:0,release:this.params.rhythm.release},volume:this.params.rhythm.volume}).connect(this.masterGain),this.rhythmNoiseSynth=new t.NoiseSynth({noise:{type:"white"},envelope:{attack:.001,decay:.04,sustain:0,release:.02},volume:this.params.rhythm.volume-8}).connect(this.masterGain),this.droneFilter=new t.Filter({frequency:this.params.drone.filterFreq,type:"lowpass",rolloff:-24}).connect(this.masterGain),this.droneSynth=new t.PolySynth(t.FMSynth,{maxPolyphony:4,voice0:{harmonicity:1.5,modulationIndex:.8,oscillator:{type:this.params.drone.waveform},envelope:{attack:this.params.drone.attack,decay:1,sustain:.8,release:this.params.drone.release},modulation:{type:"triangle"},modulationEnvelope:{attack:3,decay:.5,sustain:.7,release:5},volume:this.params.drone.volume}}).connect(this.droneFilter),this.startDrone(),this.windNoise=new t.Noise("brown").start(),this.windFilter=new t.AutoFilter({frequency:.15,baseFrequency:60,octaves:3}).connect(this.masterGain).start(),this.windGain=new t.Gain(t.dbToGain(this.params.wind.volume)).connect(this.windFilter),this.windNoise.connect(this.windGain),this.melodySynth=new t.PolySynth(t.Synth,{maxPolyphony:8,voice0:{oscillator:{type:this.params.melody.waveform+"8"},envelope:{attack:this.params.melody.attack,decay:this.params.melody.decay,sustain:.15,release:this.params.melody.release},volume:this.params.melody.volume}}).connect(this.masterGain),this.thunderSynth=new t.NoiseSynth({noise:{type:"brown"},envelope:{attack:.02,decay:2,sustain:0,release:1},volume:-8}).connect(this.reverb),this.rainSynth=new t.MetalSynth({frequency:1200,envelope:{attack:.001,decay:.015,release:.01},harmonicity:15,modulationIndex:30,volume:-28}).connect(this.masterGain),this.initialized=!0,this.enabled=!0,console.log("üîä Sound: 3 layers active (rhythm + drone + melody)")}startDrone(){if(!(!this.droneSynth||!this.Tone||this.params.drone.muted))try{const t=this.Tone.Frequency(this.droneFreq).toNote(),i=this.Tone.Frequency(this.droneFreq*1.5).toNote();this.droneSynth.triggerAttack([t,i])}catch{}}setParam(t,i,s){this.params[t]&&(this.params[t][i]=s,this.applyParams(t))}applyParams(t){if(!(!this.initialized||!this.Tone))switch(t){case"rhythm":if(this.rhythmSynth){this.rhythmSynth.volume.value=this.params.rhythm.muted?-1/0:this.params.rhythm.volume;try{this.rhythmSynth.set({envelope:{attack:this.params.rhythm.attack,decay:this.params.rhythm.decay,release:this.params.rhythm.release}})}catch{}}this.rhythmNoiseSynth&&(this.rhythmNoiseSynth.volume.value=this.params.rhythm.muted?-1/0:this.params.rhythm.volume-8);break;case"drone":if(this.droneSynth){this.droneSynth.volume.value=this.params.drone.muted?-1/0:this.params.drone.volume;try{this.droneSynth.set({voice0:{oscillator:{type:this.params.drone.waveform},envelope:{attack:this.params.drone.attack,release:this.params.drone.release}}})}catch{}this.droneFilter&&this.droneFilter.frequency.rampTo(this.params.drone.filterFreq,1)}break;case"melody":if(this.melodySynth){this.melodySynth.volume.value=this.params.melody.muted?-1/0:this.params.melody.volume;try{this.melodySynth.set({voice0:{oscillator:{type:this.params.melody.waveform+"8"},envelope:{attack:this.params.melody.attack,decay:this.params.melody.decay,release:this.params.melody.release}}})}catch{}this.reverb&&this.reverb.wet.rampTo(this.params.melody.reverb,.5)}break;case"wind":if(this.windGain){const i=this.params.wind.muted?-80:this.params.wind.volume;this.windGain.gain.rampTo(this.Tone.dbToGain(i),.3)}break}}disable(){if(this.enabled=!1,this.droneSynth)try{this.droneSynth.releaseAll()}catch{}}toggle(){return this.enabled?(this.disable(),!1):(this.enable(),!0)}onKey(t,i){if(!this.enabled||!this.melodySynth)return;const s=t.key;if(s.length!==1||this.params.melody.muted)return;let r;if(this.params.melody.mode==="piano"){if(r=Tt[s.toLowerCase()],r===void 0)return}else{const n=J[this.currentScale],o=s.toLowerCase().charCodeAt(0),h=o%n.length,l=Math.floor(o%26/n.length);r=60+n[h]+l*12}const e=440*Math.pow(2,(r-69)/12);try{const n=this.Tone.Frequency(e).toNote();this.melodySynth.triggerAttackRelease(n,"8n")}catch{}if(!this.params.rhythm.muted){const n=Date.now();if(n-this.lastNoteTime>50){try{this.rhythmNoiseSynth.triggerAttackRelease("32n")}catch{}this.lastNoteTime=n}}this.noteIndex++}onLetterErosion(t){if(!this.enabled||!this.rhythmSynth||this.params.rhythm.muted)return;const i=J[this.currentScale],r=(t.char||"a").toLowerCase().charCodeAt(0)%i.length,e=36+i[r],n=440*Math.pow(2,(e-69)/12);try{this.rhythmSynth.triggerAttackRelease(n,"16n")}catch{}}playThunder(t){if(!(!this.enabled||!this.thunderSynth))try{this.thunderSynth.volume.value=-12+t*8,this.thunderSynth.triggerAttackRelease("2n")}catch{}}updateDrone(t,i){if(!this.droneSynth||!this.Tone||this.params.drone.muted)return;const s=Object.keys(z).map(Number).sort((a,u)=>a-u);let r=z[0];for(const a of s)t>=a&&(r=z[a]);const e=this.Tone.Frequency(r).toFrequency();if(Math.abs(this.droneFreq-e)>1){this.droneFreq=e;try{this.droneSynth.releaseAll(),setTimeout(()=>this.startDrone(),100)}catch{}}const n=i.get("temperature"),o=this.params.drone.filterFreq,h=L(Math.max(o*.3,100),o,b((n+10)/55,0,1));this.droneFilter&&this.droneFilter.frequency.rampTo(h,2);const l=i.get("storm")/100;this.droneFilter&&this.droneFilter.Q.rampTo(l*8,1)}update(t,i){if(!this.enabled||!this.initialized)return;const s=i.weather,r=s.get("wind")/100,e=s.get("rain")/100,n=s.getCurrentHour();if(this.updateDrone(n,s),this.windGain&&this.Tone&&!this.params.wind.muted){const a=this.params.wind.volume+r*15;this.windGain.gain.rampTo(this.Tone.dbToGain(a),.5)}if(e>.1&&this.rainSynth&&!this.params.rhythm.muted&&Math.random()<e*.04)try{this.rainSynth.triggerAttackRelease("64n")}catch{}const o=s.get("storm")/100,h=s.get("temperature");o>.5?this.currentScale="phrygian":h<5?this.currentScale="aeolian":h>30?this.currentScale="lydian":this.currentScale="pentatonic"}}class Et{constructor(){this.dictionary={},this.specialWords={},this.poles={},this.loaded=!1}async load(){try{const[t,i]=await Promise.all([fetch("./data/semantic_dict.json"),fetch("./data/special_words.json")]);if(t.ok){const s=await t.json();this.dictionary=s.words||{},this.poles=s.poles||{},console.log(`üìñ Semantic dict: ${Object.keys(this.dictionary).length} words`)}i.ok&&(this.specialWords=await i.json(),console.log(`‚≠ê Special words: ${Object.keys(this.specialWords).length}`)),this.loaded=!0}catch(t){console.warn("‚ö†Ô∏è Could not load semantic dictionary:",t.message),console.log("   The experience will work without word recognition.")}}lookup(t){if(!this.loaded)return null;const i=t.toLowerCase().trim();if(i.length<2)return null;const s={},r=this.dictionary[i];r&&(s.effects=r.effects,s.poles=r.poles);const e=this.specialWords[i];return e&&(s.special=e,s.effects||(s.effects={})),s.effects||s.special?s:null}}class vt{constructor(){this.x=-100,this.y=-100,this.targetX=-100,this.targetY=-100,this.visible=!1,this.trail=[],this.maxTrail=80,this.lastTrailTime=0,this.lastX=0,this.lastY=0,this.speed=0}init(t){}update(t,i){this.targetX=t,this.targetY=i,this.visible=!0;const s=t-this.lastX,r=i-this.lastY;this.speed=Math.sqrt(s*s+r*r),this.lastX=t,this.lastY=i,this.x+=(this.targetX-this.x)*.2,this.y+=(this.targetY-this.y)*.2;const e=Date.now();if(this.speed>1.5&&e-this.lastTrailTime>20){this.lastTrailTime=e;const n=Math.min(3,Math.floor(this.speed/8)+1);for(let o=0;o<n;o++)this.trail.push({x:this.x+f(-3,3),y:this.y+f(-3,3),vx:f(-.5,.5)-s*.05,vy:f(-.5,.5)-r*.05-f(.1,.4),life:f(800,2e3),maxLife:f(800,2e3),size:f(1.5,4),pulse:f(0,Math.PI*2),pulseSpeed:f(3,8)});for(;this.trail.length>this.maxTrail;)this.trail.shift()}}render(t,i,s,r){if(!this.visible)return;const e=r<6||r>20?1:r<8?(8-r)/2:r>18?(r-18)/2:0,n=m.CURSOR.LIGHT_RADIUS,o=m.CURSOR.GLOW_COLOR,h=m.CURSOR.GLOW_INTENSITY*(.5+e*.5),l=Date.now()*.001;for(let c=this.trail.length-1;c>=0;c--){const p=this.trail[c];if(p.life-=16,p.x+=p.vx,p.y+=p.vy,p.vy-=.003,p.life<=0){this.trail.splice(c,1);continue}const w=p.life/p.maxLife,g=.5+.5*Math.sin(l*p.pulseSpeed+p.pulse),S=w*g*h*.7,E=p.size*(.5+w*.5);if(S<.01)continue;const v=t.createRadialGradient(p.x,p.y,0,p.x,p.y,E*3);v.addColorStop(0,`rgba(255, 230, 150, ${S*.8})`),v.addColorStop(.4,`rgba(255, 200, 100, ${S*.3})`),v.addColorStop(1,"rgba(255, 180, 80, 0)"),t.fillStyle=v,t.beginPath(),t.arc(p.x,p.y,E*3,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 245, 220, ${S*.9})`,t.beginPath(),t.arc(p.x,p.y,E*.5,0,Math.PI*2),t.fill()}const a=.9+.1*Math.sin(l*6)*Math.sin(l*9.7),u=h*a,d=t.createRadialGradient(this.x,this.y,0,this.x,this.y,n);d.addColorStop(0,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, ${u*.25})`),d.addColorStop(.3,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, ${u*.1})`),d.addColorStop(.6,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, ${u*.03})`),d.addColorStop(1,`rgba(${o[0]*255|0}, ${o[1]*255|0}, ${o[2]*255|0}, 0)`),t.fillStyle=d,t.beginPath(),t.arc(this.x,this.y,n,0,Math.PI*2),t.fill();const T=3+Math.sin(l*7)*.5;t.fillStyle=`rgba(255, 235, 190, ${.7+e*.3})`,t.beginPath(),t.arc(this.x,this.y,T,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 220, 150, ${u*.08})`,t.beginPath(),t.arc(this.x,this.y,n*1.5,0,Math.PI*2),t.fill()}}class It{constructor(){this.performanceMode=!1,this.app=null}init(t,i,s,r){this.weather=i,this.sound=s,this.app=r,document.querySelectorAll(".panel-close").forEach(e=>{e.addEventListener("click",()=>{var o;const n=e.dataset.close;(o=document.getElementById(n))==null||o.classList.add("hidden")})}),this.wireButton("btn-controls",()=>this.togglePanel("controls")),this.wireButton("btn-shortcuts",()=>this.togglePanel("panel-shortcuts")),this.wireButton("btn-about",()=>this.togglePanel("panel-about")),this.wireButton("btn-fullscreen",()=>this.toggleFullscreen()),this.wireButton("btn-sound",async()=>{const e=await s.toggle();document.getElementById("btn-sound").textContent=e?"üîä":"üîá"}),this.wireButton("btn-capture",()=>this.captureScreenshot(t.canvas)),document.querySelectorAll(".tab").forEach(e=>{e.addEventListener("click",()=>{var o;const n=e.closest(".panel");n.querySelectorAll(".tab").forEach(h=>h.classList.remove("active")),n.querySelectorAll(".tab-content").forEach(h=>h.classList.remove("active")),e.classList.add("active"),(o=document.getElementById(e.dataset.tab))==null||o.classList.add("active")})}),this.wireSlider("ctrl-wind",e=>i.set("wind",e)),this.wireSlider("ctrl-wind-dir",e=>i.set("windDir",e),e=>e+"¬∞"),this.wireSlider("ctrl-rain",e=>i.set("rain",e)),this.wireSlider("ctrl-fog",e=>i.set("fog",e)),this.wireSlider("ctrl-temp",e=>i.set("temperature",e),e=>e+"¬∞C"),this.wireSlider("ctrl-storm",e=>i.set("storm",e)),this.wireSlider("ctrl-hour",e=>{i.set("hourOverride",e<0?-1:e)},e=>e<0?"Auto":`${Math.floor(e)}:${String(Math.floor(e%1*60)).padStart(2,"0")}`),this.wireSlider("ctrl-persist",e=>{m.TEXT.LIFE_MIN=e*1e3,m.TEXT.LIFE_MAX=e*2e3},e=>e+"s"),this.wireSlider("ctrl-explosion",e=>{m.TEXT.PARTICLES_PER_LETTER=e},e=>e),this.wireSlider("ctrl-ink-hue",e=>{m.TEXT._hueOverride=e},e=>e===0?"Auto":e+"¬∞"),this.wireSelect("ctrl-font",e=>{m.TEXT.FONT_FAMILY=e}),this.wireToggle("ctrl-rhythm-mute",e=>s.setParam("rhythm","muted",!e)),this.wireSlider("ctrl-rhythm-vol",e=>s.setParam("rhythm","volume",e),e=>e+" dB"),this.wireSlider("ctrl-rhythm-attack",e=>s.setParam("rhythm","attack",e),e=>e.toFixed(3)),this.wireSlider("ctrl-rhythm-decay",e=>s.setParam("rhythm","decay",e),e=>e.toFixed(2)),this.wireSlider("ctrl-rhythm-release",e=>s.setParam("rhythm","release",e),e=>e.toFixed(2)),this.wireToggle("ctrl-wind-mute",e=>s.setParam("wind","muted",!e)),this.wireSlider("ctrl-wind-vol",e=>s.setParam("wind","volume",e),e=>e+" dB"),this.wireToggle("ctrl-drone-mute",e=>s.setParam("drone","muted",!e)),this.wireSlider("ctrl-drone-vol",e=>s.setParam("drone","volume",e),e=>e+" dB"),this.wireSlider("ctrl-drone-filter",e=>s.setParam("drone","filterFreq",e),e=>e+" Hz"),this.wireSlider("ctrl-drone-attack",e=>s.setParam("drone","attack",e),e=>e.toFixed(1)+"s"),this.wireSlider("ctrl-drone-release",e=>s.setParam("drone","release",e),e=>e.toFixed(1)+"s"),this.wireSelect("ctrl-drone-wave",e=>s.setParam("drone","waveform",e)),this.wireToggle("ctrl-melody-mute",e=>s.setParam("melody","muted",!e)),this.wireSlider("ctrl-melody-vol",e=>s.setParam("melody","volume",e),e=>e+" dB"),this.wireSelect("ctrl-melody-mode",e=>s.setParam("melody","mode",e)),this.wireSelect("ctrl-melody-wave",e=>s.setParam("melody","waveform",e)),this.wireSlider("ctrl-melody-attack",e=>s.setParam("melody","attack",e),e=>e.toFixed(3)),this.wireSlider("ctrl-melody-decay",e=>s.setParam("melody","decay",e),e=>e.toFixed(2)),this.wireSlider("ctrl-melody-release",e=>s.setParam("melody","release",e),e=>e.toFixed(1)),this.wireSlider("ctrl-melody-reverb",e=>s.setParam("melody","reverb",e),e=>e.toFixed(2)),this.wireFileImport(),this.wireSlider("ctrl-auto-bpm",e=>{this.app&&this.app.setAutoBPM(e)},e=>e+" BPM"),this.wireButton("btn-auto-play",()=>{if(!this.app)return;const e=this.app.toggleAutoPlay(),n=document.getElementById("btn-auto-play");n&&(n.textContent=e?"‚è∏ Pausar":"‚ñ∂ Reproducir")}),this.wireButton("btn-auto-stop",()=>{if(!this.app)return;this.app.stopAutoPlay();const e=document.getElementById("btn-auto-play");e&&(e.textContent="‚ñ∂ Reproducir");const n=document.getElementById("auto-status");n&&(n.textContent="Sin archivo")}),this.startClock()}wireButton(t,i){const s=document.getElementById(t);s&&s.addEventListener("click",i)}wireSlider(t,i,s){const r=document.getElementById(t),e=document.querySelector(`[data-for="${t}"]`);if(!r)return;const n=()=>{const o=parseFloat(r.value);i(o),e&&(e.textContent=s?s(o):o)};r.addEventListener("input",n),n()}wireToggle(t,i){const s=document.getElementById(t);s&&s.addEventListener("change",()=>i(s.checked))}wireSelect(t,i){const s=document.getElementById(t);s&&s.addEventListener("change",()=>i(s.value))}wireFileImport(){const t=document.getElementById("file-import"),i=document.getElementById("btn-file-import");!t||!i||(i.addEventListener("click",()=>t.click()),t.addEventListener("change",s=>{const r=s.target.files[0];if(!r)return;const e=new FileReader;e.onload=n=>{const o=n.target.result;if(this.app){this.app.loadAutoText(o);const h=document.getElementById("auto-status");h&&(h.textContent=`${r.name} (${o.length} chars)`);const l=document.getElementById("btn-auto-play");l&&(l.textContent="‚è∏ Pausar")}},e.readAsText(r,"UTF-8")}))}togglePanel(t){const i=document.getElementById(t);i&&(document.querySelectorAll(".panel").forEach(s=>{s.id!==t&&s.classList.add("hidden")}),i.classList.toggle("hidden"))}closeAllPanels(){document.querySelectorAll(".panel").forEach(t=>t.classList.add("hidden"))}startClock(){const t=document.getElementById("clock");if(!t)return;const i=()=>{const s=new Date;t.textContent=`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}:${String(s.getSeconds()).padStart(2,"0")}`};i(),setInterval(i,1e3)}togglePerformanceMode(){var s,r,e,n;this.performanceMode=!this.performanceMode;const t=["controls","panel-shortcuts","panel-about","clock"],i=document.querySelector(".floating-bar");this.performanceMode?(t.forEach(o=>{var h;return(h=document.getElementById(o))==null?void 0:h.classList.add("hidden")}),i&&(i.style.display="none"),(r=(s=document.documentElement).requestFullscreen)==null||r.call(s).catch(()=>{})):(i&&(i.style.display=""),(e=document.getElementById("clock"))==null||e.classList.remove("hidden"),document.fullscreenElement&&((n=document.exitFullscreen)==null||n.call(document).catch(()=>{})))}toggleFullscreen(){var t,i,s;document.fullscreenElement?(t=document.exitFullscreen)==null||t.call(document).catch(()=>{}):(s=(i=document.documentElement).requestFullscreen)==null||s.call(i).catch(()=>{})}captureScreenshot(t){const i=document.createElement("a");i.download=`text2wind_${Date.now()}.png`,i.href=t.toDataURL("image/png"),i.click()}}const Q="text2wind_memory";class bt{constructor(){this.traces=[],this.revealTimer=0,this.agingLevel=0,this.accelerateTimer=0,this.loaded=!1}init(t){this.load()}load(){try{const t=localStorage.getItem(Q);if(t){const i=JSON.parse(t);this.agingLevel=i.agingLevel||0,this.traces=i.traces||[],this.traces.length>500&&(this.traces=this.traces.slice(-500)),this.loaded=!0}}catch{}}save(){try{localStorage.setItem(Q,JSON.stringify({agingLevel:this.agingLevel,traces:this.traces.slice(-200)}))}catch{}}recordLetter(t){this.traces.push({x:t.x,y:t.y,char:t.char,intensity:t.contemplated?.8:.4,timestamp:Date.now()}),this.agingLevel=b(this.agingLevel+.001,0,1),this.traces.length%20===0&&this.save()}reveal(t){this.revealTimer=t}accelerateAging(t){this.accelerateTimer=t}update(t,i){this.revealTimer>0&&(this.revealTimer-=t),this.accelerateTimer>0&&(this.accelerateTimer-=t,this.agingLevel=b(this.agingLevel+5e-4*t,0,1)),this.agingLevel=b(this.agingLevel+1e-6*t,0,1)}render(t,i,s,r){const e=r.cursor;this.agingLevel>.01&&(t.fillStyle=`rgba(30, 25, 15, ${this.agingLevel*.08})`,t.fillRect(0,0,i,s));const n=this.revealTimer>0;for(const o of this.traces){let h=0;if(n)h=o.intensity*.4*Math.min(this.revealTimer/1e3,1);else{const l=o.x-e.x,a=o.y-e.y,u=Math.sqrt(l*l+a*a);u<80&&(h=o.intensity*.3*(1-u/80))}h>.01&&(t.fillStyle=`rgba(180, 170, 140, ${h})`,t.font='28px "JetBrains Mono", monospace',t.fillText(o.char,o.x,o.y))}}}class Lt{constructor(){this.mode="contemplator",this.keyTimestamps=[],this.idleTime=0,this.wpm=0,this.blend={writer:0,contemplator:1,storm:0},this.suspensionTimer=0}init(t){}onKey(t){if(t.key.length===1){this.keyTimestamps.push(Date.now()),this.idleTime=0;const i=Date.now()-3e4;this.keyTimestamps=this.keyTimestamps.filter(s=>s>i)}}triggerSuspension(t){this.suspensionTimer=t}getMode(){return this.mode}getBlend(){return this.blend}isSuspended(){return this.suspensionTimer>0}update(t,i){if(this.idleTime+=t,this.suspensionTimer>0){this.suspensionTimer-=t;return}const s=Date.now()-15e3,r=this.keyTimestamps.filter(o=>o>s).length;this.wpm=r/5*4;const e=m.MODES;this.wpm>=e.STORM_WPM_THRESHOLD?this.mode="storm":this.wpm>=e.WRITER_WPM_THRESHOLD?this.mode="writer":this.idleTime>e.CONTEMPLATOR_IDLE&&(this.mode="contemplator");const n={writer:0,contemplator:0,storm:0};n[this.mode]=1;for(const o in this.blend)this.blend[o]=L(this.blend[o],n[o],.002*t)}}class Mt{constructor(){this.drops=[],this.maxDrops=2e3}init(t){}resize(t){}update(t,i){const s=i.weather.get("rain")/100;if(s<.05){this.drops=[];return}const r=window.innerWidth,e=window.innerHeight,n=i.weather.get("windDir"),o=i.weather.get("wind")/100,h=Math.floor(s*this.maxDrops);for(;this.drops.length<h;)this.drops.push({x:f(-50,r+50),y:f(-50,-10),speed:f(8,16)*(.5+s),length:f(10,25)*s,opacity:f(.1,.4)*s,windOffset:Math.sin(n*Math.PI/180)*o*3});for(let l=this.drops.length-1;l>=0;l--){const a=this.drops[l];a.y+=a.speed*t*.1,a.x+=a.windOffset*t*.05,a.y>e+20&&(this.drops.length>h?this.drops.splice(l,1):(a.y=f(-50,-10),a.x=f(-50,r+50)))}}render(t,i,s,r){if(this.drops.length===0)return;const e=r.weather.get("windDir")*Math.PI/180,n=Math.sin(e)*(r.weather.get("wind")/100)*10;t.strokeStyle="rgba(180, 200, 220, 0.3)",t.lineWidth=1;for(const o of this.drops)t.globalAlpha=o.opacity,t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(o.x+n,o.y+o.length),t.stroke();t.globalAlpha=1}}class Pt{constructor(){this.blades=[],this.lastTextTime=Date.now()}init(t){}update(t,i){var n;if((((n=i.text.letters)==null?void 0:n.length)||0)>0&&(this.lastTextTime=Date.now()),Date.now()-this.lastTextTime>m.GRASS.IDLE_THRESHOLD&&this.blades.length<m.GRASS.MAX_BLADES){const o=i.memory;if(o.traces.length>0){const h=o.traces[Math.floor(Math.random()*o.traces.length)];this.blades.push({x:h.x+f(-15,15),y:h.y+f(-5,5),height:0,maxHeight:f(m.GRASS.BLADE_HEIGHT_MIN,m.GRASS.BLADE_HEIGHT_MAX),width:f(1,3),growSpeed:f(.001,.003),phase:Math.random()*Math.PI*2})}else this.blades.push({x:f(40,window.innerWidth-40),y:f(window.innerHeight*.7,window.innerHeight-20),height:0,maxHeight:f(m.GRASS.BLADE_HEIGHT_MIN,m.GRASS.BLADE_HEIGHT_MAX),width:f(1,3),growSpeed:f(.001,.003),phase:Math.random()*Math.PI*2})}i.weather.get("wind")/100;for(const o of this.blades)o.height<o.maxHeight&&(o.height+=o.growSpeed*t)}render(t,i,s,r){if(this.blades.length===0)return;const e=Date.now()*.001,n=r.weather.get("wind")/100,o=r.weather.get("windDir"),h=r.weather.getCurrentHour(),l=h<6||h>20?1:h<8?(8-h)/2:h>18?(h-18)/2:0,a=m.GRASS.COLOR,u=Math.round(a[0]*(1-l*.6)*255),d=Math.round(a[1]*(1-l*.4)*255),T=Math.round(a[2]*(1-l*.5)*255);for(const c of this.blades){if(c.height<1)continue;const p=Math.sin(e*2+c.phase)*n*c.height*.3+Math.sin(o*.017)*n*c.height*.2,w=b(c.height/c.maxHeight,.3,.8);t.strokeStyle=`rgba(${u},${d},${T},${w})`,t.lineWidth=c.width,t.lineCap="round",t.beginPath(),t.moveTo(c.x,c.y),t.quadraticCurveTo(c.x+p*.5,c.y-c.height*.5,c.x+p,c.y-c.height),t.stroke()}}}class xt{constructor(){this.flashTimer=0,this.flashIntensity=0,this.bolt=null}init(t){}update(t,i){var r,e;const s=i.weather.get("storm")/100;if(this.flashTimer>0){this.flashTimer-=t;return}s>.3&&Math.random()<s*3e-4*t&&(this.flash(s),(e=(r=i.sound)==null?void 0:r.playThunder)==null||e.call(r,s))}flash(t){this.flashTimer=150+t*200,this.flashIntensity=.3+t*.5;const i=window.innerWidth,s=f(i*.2,i*.8),r=[];let e=s,n=0;for(;n<window.innerHeight*.7;)e+=f(-30,30),n+=f(20,60),r.push({x:e,y:n});this.bolt=r}render(t,i,s,r){if(this.flashTimer<=0)return;const e=this.flashIntensity*(this.flashTimer/300);if(t.fillStyle=`rgba(220, 220, 255, ${e*.3})`,t.fillRect(0,0,i,s),this.bolt&&this.flashTimer>100){t.strokeStyle=`rgba(255, 255, 255, ${e})`,t.lineWidth=2,t.shadowColor="rgba(200, 200, 255, 0.8)",t.shadowBlur=15,t.beginPath(),t.moveTo(this.bolt[0].x,0);for(const n of this.bolt)t.lineTo(n.x,n.y);t.stroke(),t.shadowBlur=0}}}class At{constructor(){}init(t){}render(t,i,s,r){const e=r.weather.get("fog")/100;if(e<.05)return;const n=e*.5,o=r.weather.getCurrentHour(),h=o<6||o>20?1:o<8?(8-o)/2:o>18?(o-18)/2:0,l=h>.5?30:200,a=h>.5?30:195,u=h>.5?40:190,d=t.createLinearGradient(0,0,0,s);d.addColorStop(0,`rgba(${l},${a},${u},${n*.3})`),d.addColorStop(.6,`rgba(${l},${a},${u},${n*.5})`),d.addColorStop(1,`rgba(${l},${a},${u},${n*.8})`),t.fillStyle=d,t.fillRect(0,0,i,s)}}class kt{constructor(){this.canvas=document.getElementById("world"),this.ctx=this.canvas.getContext("2d"),this.running=!1,this.started=!1,this.lastTime=0,this.sky=new dt,this.wind=new ut,this.particles=new mt,this.text=new ft,this.weather=new pt,this.sound=new St,this.semantic=new Et,this.cursor=new vt,this.ui=new It,this.memory=new bt,this.modes=new Lt,this.rain=new Mt,this.grass=new Pt,this.lightning=new xt,this.fog=new At,this.autoText=null,this.autoIndex=0,this.autoTimer=0,this.autoBPM=120,this.autoPlaying=!1,this.resize=this.resize.bind(this),this.loop=this.loop.bind(this),this.onKey=this.onKey.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}async init(){this.resize(),window.addEventListener("resize",this.resize),await this.semantic.load();const t=this.getState();this.sky.init(t),this.wind.init(t),this.particles.init(t),this.text.init(t),this.weather.init(t),this.cursor.init(t),this.memory.init(t),this.modes.init(t),this.rain.init(t),this.grass.init(t),this.lightning.init(t),this.fog.init(t),this.ui.init(t,this.weather,this.sound,this),window.addEventListener("keydown",this.onKey),window.addEventListener("mousemove",this.onMouseMove),window.addEventListener("touchmove",i=>{i.touches.length>0&&this.cursor.update(i.touches[0].clientX,i.touches[0].clientY)}),this.canvas.addEventListener("click",i=>{if(!this.started){this.startApp();return}i.target===this.canvas&&this.text.onCanvasClick(i.clientX,i.clientY,this.getState())}),document.getElementById("intro").addEventListener("click",()=>this.startApp()),document.addEventListener("paste",i=>{if(!this.started||i.target.tagName==="INPUT"||i.target.tagName==="SELECT"||i.target.tagName==="TEXTAREA")return;i.preventDefault();const s=(i.clipboardData||window.clipboardData).getData("text");if(!s)return;const r=this.getState();for(const e of s)e===`
`?(this.text.checkWord(r),this.text.newLine()):e===" "?(this.text.addLetter(" ",r),this.text.checkWord(r)):e.length===1&&(this.text.addLetter(e,r),this.text.wordBuffer+=e.toLowerCase(),this.sound.onKey({key:e},this.weather))}),console.log("üåæ Text2Wind initialized")}startApp(){this.started||(this.started=!0,this.running=!0,document.getElementById("intro").classList.add("hidden"),this.lastTime=performance.now(),requestAnimationFrame(this.loop),this.sound.toggle().then(t=>{const i=document.getElementById("btn-sound");i&&(i.textContent=t?"üîä":"üîá")}))}getState(){return{canvas:this.canvas,ctx:this.ctx,width:this.canvas.width,height:this.canvas.height,weather:this.weather,wind:this.wind,cursor:this.cursor,particles:this.particles,memory:this.memory,semantic:this.semantic,text:this.text,modes:this.modes,sound:this.sound}}resize(){const t=m.PIXEL_RATIO;this.canvas.width=window.innerWidth*t,this.canvas.height=window.innerHeight*t,this.canvas.style.width=window.innerWidth+"px",this.canvas.style.height=window.innerHeight+"px",this.ctx.scale(t,t);const i=this.getState();this.sky.resize(i),this.particles.resize(i),this.text.resize(i),this.rain.resize(i)}onKey(t){var i;if(this.started){if(t.key==="F11"){t.preventDefault(),this.ui.togglePerformanceMode();return}if(t.key==="Escape"){this.ui.closeAllPanels(),document.fullscreenElement&&((i=document.exitFullscreen)==null||i.call(document));return}t.target.tagName==="INPUT"||t.target.tagName==="SELECT"||(this.text.onKey(t,this.getState()),this.modes.onKey(t),this.sound.onKey(t,this.weather))}}onMouseMove(t){this.cursor.update(t.clientX,t.clientY)}loadAutoText(t){this.autoText=t,this.autoIndex=0,this.autoTimer=0,this.autoPlaying=!0,console.log(`üìñ Auto-typewriter: ${t.length} chars loaded`)}setAutoBPM(t){this.autoBPM=Math.max(10,Math.min(600,t))}toggleAutoPlay(){return this.autoText?(this.autoPlaying=!this.autoPlaying,this.autoPlaying):!1}stopAutoPlay(){this.autoPlaying=!1,this.autoText=null,this.autoIndex=0,this.autoTimer=0,this.text.wordBuffer=""}updateAutoTypewriter(t){if(!this.autoPlaying||!this.autoText||this.autoIndex>=this.autoText.length){this.autoText&&this.autoIndex>=this.autoText.length&&(this.autoPlaying=!1);return}this.autoTimer+=t;const i=6e4/this.autoBPM;if(this.autoTimer>=i){this.autoTimer-=i;const s=this.autoText[this.autoIndex],r=this.getState();s===`
`?(this.text.checkWord(r),this.text.newLine()):s===" "?(this.text.addLetter(" ",r),this.text.checkWord(r)):(this.text.addLetter(s,r),this.text.wordBuffer+=s.toLowerCase(),this.sound.onKey({key:s},this.weather)),this.autoIndex++}}loop(t){if(!this.running)return;const i=Math.min(t-this.lastTime,50);this.lastTime=t;const s=this.getState(),r=window.innerWidth,e=window.innerHeight,n=this.weather.getCurrentHour();this.weather.update(i,s),this.wind.update(i,s),this.modes.update(i,s),this.text.update(i,s),this.particles.update(i,s),this.grass.update(i,s),this.rain.update(i,s),this.lightning.update(i,s),this.memory.update(i,s),this.sound.update(i,s),this.updateAutoTypewriter(i),this.ctx.save(),this.sky.render(this.ctx,r,e,n,this.weather),this.memory.render(this.ctx,r,e,s),this.grass.render(this.ctx,r,e,s),this.text.render(this.ctx,r,e,s),this.particles.render(this.ctx,r,e,s),this.rain.render(this.ctx,r,e,s),this.lightning.render(this.ctx,r,e,s),this.fog.render(this.ctx,r,e,s),this.cursor.render(this.ctx,r,e,n),this.ctx.restore(),requestAnimationFrame(this.loop)}}const Rt=new kt;Rt.init().catch(y=>console.error("Text2Wind init error:",y));
